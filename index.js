const C={A:'0xD9157453E2668B2fc45b7A803D3FEF3642430cC0',B:[{inputs:[{name:"_queryId",type:"bytes32"},{name:"_value",type:"bytes"},{name:"_nonce",type:"uint256"},{name:"_queryData",type:"bytes"}],name:"submitValue"},{inputs:[{name:"_queryId",type:"bytes32"}],name:"getNewValueCountbyQueryId",outputs:[{type:"uint256"}]}],u:'api.scan.pulsechain.com/api/v2/addresses/',b:100,m:10,r:3,t:3e5,k:'i',c:'0x434F4D4D454E54'},R=class{constructor(m=100){this.d=new Map;this.t=new Map}g(k){const v=this.d.get(k);v&&this.t.set(k,Date.now());return v}s(k,v){const n=Date.now();[...this.t].forEach(([k,t])=>{n-t>C.t&&(this.d.delete(k),this.t.delete(k))});this.d.set(k,v);this.t.set(k,n)}},A=class{constructor(){this.e=window.ethers;this.h=new R;this.s={i:[],l:0,n:0,p:null,r:new Set,t:0};this._=document.getElementById.bind(document);this.u();this.b();this.l();this.f();setInterval(()=>{this.h.s();this.c()},C.t)}u(){const m=document.createElement('div');m.id='m';m.innerHTML='<div id=n><button class=x>×</button><div id=r></div><div id=s><div id=l></div><div class=i><textarea id=t></textarea><button id=cs>💬</button></div></div></div><div id=o></div>';document.body.appendChild(m);const s=document.createElement('style');s.textContent='#m{display:none;position:fixed;inset:0;background:#0008;z-index:9}#n{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:600px;background:#13101c;border-radius:12px;padding:20px;max-height:90vh;display:flex;flex-direction:column}.x{position:absolute;right:12px;top:12px;background:0;border:0;color:#fff;font-size:24px;cursor:pointer}#s{flex:1;display:flex;flex-direction:column;min-height:0}#l{flex:1;overflow-y:auto;margin:0 -12px 20px;padding:0 12px}.i{border-top:1px solid#2a2438;padding:20px 0}#t{width:100%;height:80px;background:#1a1327;border:1px solid#2a2438;border-radius:8px;padding:12px;color:#fff;margin:0 0 10px;resize:vertical}#cs{background:#7c4dff;color:#fff;border:0;padding:8px 16px;border-radius:4px;cursor:pointer}#cs:hover{background:#6c3aef}#cs:disabled{opacity:.5}.m{padding:15px;border-bottom:1px solid#2a2438}#o{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#2a2438;color:#fff;padding:12px 24px;border-radius:8px;z-index:9;display:none}';document.head.appendChild(s)}b(){const a={x:()=>this.h(),cs:()=>this.pc(),connectWallet:()=>this.w(),publishStory:()=>this.ps(),loadMoreButton:()=>this.c()};document.addEventListener('click',e=>{const t=e.target,i=t.id;if(a[i])a[i]();else if(t.matches('.action-btn')){const p=t.closest('.report-actions')?.dataset;if(p){const{action:a,queryId:q,reporter:r,timestamp:ts}=t.dataset;a==='comment'?this.sm(q):a==='dispute'&&window.disputeNews(r,q,ts)}}});const s=this._('searchInput'),t=this._('t');s&&(s.oninput=e=>{clearTimeout(s._t);s._t=setTimeout(()=>this.sr(),300)});t&&new ResizeObserver(()=>requestAnimationFrame(()=>t.style.height=t.scrollHeight+'px')).observe(t)}async c(){if(this.s.l||Date.now()-this.s.t<3e4)return;this.s.l=1;this.g(1);try{const r=await this.tx(),n=await this.p(r),u=n.filter(x=>!this.s.i.some(y=>y.queryId===x.queryId));u.length&&(this.s.i.unshift(...u),this.r(u,1),localStorage.setItem(C.k,JSON.stringify(this.s.i.slice(0,50))),this.t(`+${u.length}`));this.s.t=Date.now()}catch(e){console.error(e)}finally{this.s.l=0;this.g(0)}}async tx(p){const k=p?JSON.stringify(p):'_',v=this.h.g(k);if(v)return v;const u=`https://${C.u}${C.A}/transactions?filter=to&sort=desc&limit=${C.b}${p?'&'+new URLSearchParams(p):''}`;if(this.s.r.has(u))return new Promise(r=>setTimeout(()=>r(this.tx(p)),100));this.s.r.add(u);try{const r=await fetch(u).then(r=>r.json());this.h.s(k,r);return r}finally{this.s.r.delete(u)}}async f(x){if(this.s.l||this.s.n&&!x)return;this.s.l=1;this.g(1);x&&(this.s.i=[],this.s.n=0,this.s.p=null);try{const q=[],n=[];while(n.length<C.m&&!this.s.n){q.push(this.tx(this.s.p));q.length>=C.r&&n.push(...await this.p(await q.shift()))}while(q.length)n.push(...await this.p(await q.shift()));n.length&&(this.s.i=x?n:[...this.s.i,...n],this.r(n,!x),localStorage.setItem(C.k,JSON.stringify(this.s.i.slice(0,50))));this._('loadMoreButton').style.display=this.s.n?'none':'block'}catch(e){console.error(e)}finally{this.s.l=0;this.g(0)}}async p(b){if(!b?.items?.length){this.s.n=1;return[]}const i=await Promise.all(b.items.filter(t=>t.method==='submitValue'&&t.decoded_input?.parameters?.length>3).map(async t=>{try{const[y,b]=this.e.utils.defaultAbiCoder.decode(['string','bytes'],t.decoded_input.parameters[3].value);if(y!=='StringQuery')return null;const c=await this.d(b);return c.trim()?{content:c,reporter:t.from.hash||t.from,timestamp:t.timestamp||t.block_timestamp,queryId:t.decoded_input.parameters[0].value}:null}catch{return null}}));this.s.p=b.next_page_params||null;this.s.n=!this.s.p;return i.filter(Boolean)}r(i,a){const f=this._('newsFeed');if(!i.length&&!a){f.innerHTML='No items';return}const d=document.createDocumentFragment(),t=document.createElement('template');i.forEach(m=>{t.innerHTML=`<article class="news-item"><div class="reporter-info"><img src="newTRBphoto.jpg" alt="R" class="avatar"><div class="reporter-details"><span class="reporter-name">${this.sh(m.reporter)}</span>· ${this.dt(m.timestamp)}</div></div><div class="report-content">${m.content.split('\n\n').map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}</div><div class="report-actions"data-reporter="${m.reporter}"data-query-id="${m.queryId}"data-timestamp="${m.timestamp}"><button class="action-btn"data-action="comment">💬</button><button class="action-btn"data-action="like">👍</button><button class="action-btn"data-action="dispute">⚠️</button><button class="action-btn"data-action="vote">✓</button></div></article>`;d.appendChild(t.content.firstChild)});requestAnimationFrame(()=>{a||f.textContent='';f.appendChild(d);f.style.visibility='visible'})}sh=a=>a?.length>10?a.slice(0,6)+'...'+a.slice(-4):a||'-';dt=t=>new Date(t).toLocaleString('en',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'numeric'});g=s=>this._('loadingOverlay').style.display=s?'flex':'none';t=m=>{const o=this._('o');o.textContent=m;o.style.display='block';setTimeout(()=>o.style.display='none',3e3)};l=()=>{try{const s=localStorage.getItem(C.k);s&&(this.s.i=JSON.parse(s))}catch{}};h(){this._('m').style.display='none';document.body.style.overflow='';this._('t').value=''}sm(i){const r=this.s.i.find(x=>x.queryId===i);if(!r)return;this.cr=r;this._('r').innerHTML=`<div><div class="reporter-info"><img src="newTRBphoto.jpg"alt=R><div><span>${this.sh(r.reporter)}</span>· ${this.dt(r.timestamp)}</div></div><div>${r.content.split('\n\n').map(p=>`<p>${p.replace(/\n/g,'<br>')}</p>`).join('')}</div></div>`;this.lc(i);this._('m').style.display='block';document.body.style.overflow='hidden'}async lc(i){const l=this._('l');l.innerHTML='<div class="d">...</div>';try{const c=await this.gc(i);l.innerHTML=c.length?c.map(c=>`<div class="m">${this.sh(c.author)} · ${this.dt(c.timestamp)}<br>${c.text}</div>`).join(''):'No comments'}catch{l.innerHTML='Failed'}}async gc(i){const k=`c${i}`,v=this.h.g(k);if(v)return v;const r=await this.tx(),c=r.items?.filter(t=>t.value==='0'&&t.input?.startsWith(C.c)).map(t=>{try{const[q,x]=this.e.utils.defaultAbiCoder.decode(['bytes32','string'],'0x'+t.input.slice(C.c.length));return q===i?{text:x,author:t.from.hash||t.from,timestamp:t.timestamp||t.block_timestamp}:null}catch{return null}}).filter(Boolean);this.h.s(k,c);return c}async pc(){const b=this._('cs'),t=this._('t'),v=t.value.trim();if(!v)return;b.disabled=1;try{if(!window.ethereum)throw'Install MetaMask';const p=new this.e.providers.Web3Provider(window.ethereum);const s=await p.send('eth_requestAccounts',[]).then(()=>p.getSigner());await(await s.sendTransaction({to:C.A,value:'0',data:C.c+this.e.utils.defaultAbiCoder.encode(['bytes32','string'],[this.cr.queryId,v]).slice(2)})).wait();t.value='';this.lc(this.cr.queryId);this.t('✓')}catch(e){this.t(e.message||'✗')}finally{b.disabled=0}}async w(){try{if(!window.ethereum)throw'Install MetaMask';const p=new this.e.providers.Web3Provider(window.ethereum);await p.send('eth_requestAccounts',[]);const s=p.getSigner(),a=await s.getAddress();this._('connectWallet').style.display='none';this._('walletInfo').style.display='block';this._('walletAddress').textContent=this.sh(a);this._('publishStory').disabled=0;this.w=new this.e.Contract(C.A,C.B,s)}catch(e){this.t(e.message||'Failed')}}};new A
