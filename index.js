(()=>{let w=window,d=document,E=w.ethers,q=d.querySelector.bind(d),A=d.createElement.bind(d),_='display',v='none',z='block',V=new Map,T=new Set,C=new WeakMap,Y={p:0,s:0,n:[],t:Date.now()},U=new Uint8Array(32);for(let i=0;i<32;i++)U[i]=parseInt('D9157453E2668B2fc45b7A803D3FEF3642430cC0'.slice(i*2,i*2+2),16);const G={$:i=>C.get(i)||C.set(i,q('#'+i)).get(i),L:(k,d,a=w.ethereum?.selectedAddress)=>{try{return k?localStorage.setItem(`p${a}${d}`,JSON.stringify(k)):JSON.parse(localStorage.getItem(`p${a}${d}`))}catch(e){}},H:s=>s?.slice(0,6)+'...'+s?.slice(-4)||'?',R:(function(){let t,f;return(m,x)=>{if(f=G.$('newsFeed'),!m.length&&!x)return f.innerHTML='<p>No news</p>';t=t||d.createDocumentFragment();let h='',c=Date.now();m.map(i=>{if(c-new Date(i.timestamp)>864e5)return;h+=`<article class="news-item"><div class="reporter-info"><img src="newTRBphoto.jpg" alt="" class="avatar"><div class="reporter-details"><span>${G.H(i.reporter)}</span><span>Â·${new Date(i.timestamp).toLocaleString()}</span></div></div><div>${i.content.replace(/[<>"'&]/g,c=>({
'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','&':'&amp;'}[c]))}</div><div class="report-actions">${['ðŸ’¬','ðŸ‘','âš ï¸','âœ“'].map((e,j)=>`<button data-a="${'cldt'[j]}" data-r="${i.reporter}"${j==2?` data-q="${i.queryId}" data-t="${i.timestamp}"`:''}">${e}</button>`).join('')}</div></article>`});t.innerHTML=h;x||(f.innerHTML='');requestAnimationFrame(()=>{f.appendChild(t.cloneNode(true));f.style.visibility='visible'})}})()},X=new Proxy({},{get:(_,p)=>V.get(p)||V.set(p,new AbortController).get(p)});d.addEventListener('DOMContentLoaded',async _=>{const M=async _=>{try{if(!w.ethereum)throw'ðŸ“±';Y.p=new E.providers.Web3Provider(w.ethereum);await Y.p.send("eth_requestAccounts",[]);Y.s=Y.p.getSigner();let a=await Y.s.getAddress(),c=new E.Contract(U,[[{inputs:[{name:"_queryId",type:"bytes32"},{name:"_value",type:"bytes"},{name:"_nonce",type:"uint256"},{name:"_queryData",type:"bytes"}],name:"submitValue",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{name:"_queryId",type:"bytes32"}],name:"getNewValueCountbyQueryId",outputs:[{name:"",type:"uint256"}],stateMutability:"view",type:"function"}][0]],Y.s);['connectWallet','publishStory','walletInfo','walletAddress'].map(i=>{let e=G.$(i);e&&(e.style[_]=i=='walletInfo'?z:v,i=='walletAddress'&&(e.textContent=G.H(a)),i=='publishStory'&&(e.disabled=0))});G.$('reportContent').placeholder="What's happening?";w.ethereum.removeEventListener('chainChanged',location.reload);w.ethereum.removeEventListener('accountsChanged',M);w.ethereum.addEventListener('chainChanged',_=>location.reload());w.ethereum.addEventListener('accountsChanged',M)}catch(e){console.log(e)}},P=async _=>{let c=G.$('reportContent'),p=G.$('publishStory'),o=G.$('loadingOverlay'),v=c.value.trim();if(!v||Y.p)return;p.disabled=1;o.style[_]=z;try{if(!Y.s)throw'ðŸ”Œ';let b=E.utils.toUtf8Bytes(v),q=E.utils.defaultAbiCoder.encode(['string','bytes'],['StringQuery',b]),i=E.utils.keccak256(q),n=await Y.c.getNewValueCountbyQueryId(i),t=await Y.c.submitValue(i,E.utils.defaultAbiCoder.encode(['string','bytes'],['NEWS',b]),n,q,{gasLimit:(await Y.c.estimateGas.submitValue(i,v,n,q)).mul(120).div(100)});await t.wait();c.value='';let s={content:v,reporter:await Y.s.getAddress(),timestamp:new Date().toISOString(),queryId:i};Y.n.unshift(s);G.L(Y.n,'n');G.R([s],1)}catch(e){console.log(e)}finally{p.disabled=0;o.style[_]=v}};d.addEventListener('click',e=>{let t=e.target;if(t.tagName==='BUTTON'){let a=t.dataset.a;if(a){e.preventDefault();let r=t.dataset.r,q=t.dataset.q,m=t.dataset.t;console.log(a,r,q,m)}}});['connectWallet','publishStory','search-input'].map((i,x)=>{let e=G.$(i),h=X[i];h&&h.abort();if(e){if(x<2)e.addEventListener('click',x?P:M,{signal:h.signal});else{let s=_=>{let v=e.value.toLowerCase();T.add(v);setTimeout(_=>T.delete(v),300);if(T.size>1)return;G.R(Y.n.filter(i=>G.H(i.reporter).toLowerCase().includes(v)||i.content.toLowerCase().includes(v)))};e.addEventListener('input',s,{signal:h.signal});e.addEventListener('keypress',e=>'Enter'==e.key&&s(),{signal:h.signal})}}});let L=G.L(0,'n');L&&(Y.n=L,G.R(L))});})();
