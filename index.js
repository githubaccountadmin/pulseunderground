const C={A:'0xD9157453E2668B2fc45b7A803D3FEF3642430cC0',B:[{inputs:[{name:"_queryId",type:"bytes32"},{name:"_value",type:"bytes"},{name:"_nonce",type:"uint256"},{name:"_queryData",type:"bytes"}],name:"submitValue"},{inputs:[{name:"_queryId",type:"bytes32"}],name:"getNewValueCountbyQueryId",outputs:[{type:"uint256"}]}],u:'api.scan.pulsechain.com/api/v2/addresses/',b:100,m:10,r:3,t:3e5,c:'0x434F4D4D454E54'},A=function(){this.e=window.ethers;this.h=window.PUCache;this.s={i:[],l:0,n:0,p:null,r:new Set,t:0};this._=document.getElementById.bind(document)};A.prototype={setup:function(){const s=this;document.body.insertAdjacentHTML('beforeend','<div id=m><div id=n><button class=x>√ó</button><div id=r></div><div id=s><div id=l></div><div class=i><textarea id=t></textarea><button id=cs>üí¨</button></div></div></div><div id=o></div>');document.addEventListener('click',e=>{const t=e.target;if(!t)return;if(t.classList.contains('x')){s.hm();return}if(t.matches('.action-btn')){const p=t.closest('.report-actions');if(p){const d=p.dataset;if(t.dataset.action==='comment')s.sm(d.queryId);else if(t.dataset.action==='dispute'&&window.disputeNews)window.disputeNews(d.reporter,d.queryId,d.timestamp)}return}if(t.id==='connectWallet')s.w();else if(t.id==='publishStory')s.ps();else if(t.id==='loadMoreButton')s.c();else if(t.id==='cs')s.pc()});const x=this._('t');x&&new ResizeObserver(()=>requestAnimationFrame(()=>x.style.height=x.scrollHeight+'px')).observe(x);this.h.gn({l:50}).then(n=>{n.length?(this.s.i=n,this.r(n)):this.f(1)}).catch(()=>this.f(1));setInterval(()=>s.c(),C.t)},tx:async function(p){return this.h.dr(p?JSON.stringify(p):'_',async()=>{const u=`https://${C.u}${C.A}/transactions?filter=to&sort=desc&limit=${C.b}${p?'&'+new URLSearchParams(p):''}`;if(this.s.r.has(u))return new Promise(r=>setTimeout(()=>r(this.tx(p)),100));this.s.r.add(u);try{return await(await fetch(u)).json()}finally{this.s.r.delete(u)}})},c:async function(){if(this.s.l||Date.now()-this.s.t<3e4)return;this.s.l=1;this.g(1);try{const r=await this.tx(),n=await this.p(r),u=n.filter(x=>!this.s.i.some(y=>y.queryId===x.queryId));u.length&&(this.s.i.unshift(...u),await this.h.sn(u),this.r(u,1),this.t('+'+u.length));this.s.t=Date.now()}catch(e){console.error(e)}finally{this.s.l=0;this.g(0)}},f:async function(x){if(this.s.l||this.s.n&&!x)return;this.s.l=1;this.g(1);x&&(this.s.i=[],this.s.n=0,this.s.p=null);try{const q=[],n=[];while(n.length<C.m&&!this.s.n){q.push(this.tx(this.s.p));if(q.length>=C.r){const[b,i]=await Promise.all([q.shift(),this.p(await q.shift())]);n.push(...(i||[]))}}while(q.length){const[b,i]=await Promise.all([q.shift(),this.p(await q.shift())]);n.push(...(i||[]))}n.length&&(this.s.i=x?n:this.s.i.concat(n),await this.h.sn(n),this.r(n,!x));this._('loadMoreButton').style.display=this.s.n?'none':'block'}catch(e){console.error(e)}finally{this.s.l=0;this.g(0)}},p:async function(b){if(!b?.items?.length){this.s.n=1;return[]}const i=[];for(const t of b.items)if(t.decoded_input?.parameters?.length>=4&&t.method==='submitValue')try{const[y,b]=this.e.utils.defaultAbiCoder.decode(['string','bytes'],t.decoded_input.parameters[3].value);if(y==='StringQuery'){const c=this.e.utils.toUtf8String(b).trim();c&&i.push({content:c,reporter:t.from.hash||t.from,timestamp:t.timestamp||t.block_timestamp,queryId:t.decoded_input.parameters[0].value})}}catch(e){}this.s.p=b.next_page_params||null;this.s.n=!this.s.p;return i},r:function(i,a){if(!i.length&&!a)return this._('newsFeed').innerHTML='No items';const f=document.createDocumentFragment(),t=document.createElement('template'),s=this;i.forEach(m=>{t.innerHTML=`<article class="news-item"><div class="reporter-info"><img src="newTRBphoto.jpg" alt="R" class="avatar"><div class="reporter-details"><span class="reporter-name">${s.sh(m.reporter)}</span>¬∑ ${s.dt(m.timestamp)}</div></div><div class="report-content">${m.content.split('\n\n').map(p=>'<p>'+p.replace(/\n/g,'<br>')+'</p>').join('')}</div><div class="report-actions"data-reporter="${m.reporter}"data-query-id="${m.queryId}"data-timestamp="${m.timestamp}"><button class="action-btn"data-action="comment">üí¨</button><button class="action-btn"data-action="like">üëç</button><button class="action-btn"data-action="dispute">‚ö†Ô∏è</button><button class="action-btn"data-action="vote">‚úì</button></div></article>`;f.appendChild(t.content.firstChild)});const n=this._('newsFeed');requestAnimationFrame(()=>{a||(n.textContent='');n.appendChild(f);n.style.visibility='visible'})},gc:async function(i){const c=await this.h.gc(i);if(c.length)return c;const r=await this.tx(),n=[];for(const t of r.items||[])if(t.value==='0'&&t.input?.startsWith(C.c))try{const[q,x]=this.e.utils.defaultAbiCoder.decode(['bytes32','string'],'0x'+t.input.slice(C.c.length));q===i&&n.push({text:x,author:t.from.hash||t.from,timestamp:t.timestamp||t.block_timestamp})}catch(e){}n.length&&await this.h.sc(i,n);return n},pc:async function(){const t=this._('t'),b=this._('cs');if(!t||!b)return;const v=t.value.trim();if(!v)return;b.disabled=1;try{if(!window.ethereum)throw'Install MetaMask';const p=new this.e.providers.Web3Provider(window.ethereum),s=await p.send('eth_requestAccounts',[]).then(()=>p.getSigner());await(await s.sendTransaction({to:C.A,value:'0',data:C.c+this.e.utils.defaultAbiCoder.encode(['bytes32','string'],[this.cr.queryId,v]).slice(2)})).wait();t.value='';this.lc(this.cr.queryId);this.t('‚úì')}catch(e){this.t(e.message||'‚úó')}finally{b.disabled=0}},w:async function(){try{if(!window.ethereum)throw'Install MetaMask';const p=new this.e.providers.Web3Provider(window.ethereum);await p.send('eth_requestAccounts',[]);const s=p.getSigner(),a=await s.getAddress();this._('connectWallet').style.display='none';this._('walletInfo').style.display='block';this._('walletAddress').textContent=this.sh(a);this._('publishStory').disabled=0;this.w=new this.e.Contract(C.A,C.B,s)}catch(e){this.t(e.message||'Failed')}},sm:function(i){const r=this.s.i.find(x=>x.queryId===i);if(!r)return;this.cr=r;this._('r').innerHTML=`<div><div class="reporter-info"><img src="newTRBphoto.jpg"alt=R><div><span>${this.sh(r.reporter)}</span>¬∑ ${this.dt(r.timestamp)}</div></div><div>${r.content.split('\n\n').map(p=>'<p>'+p.replace(/\n/g,'<br>')+'</p>').join('')}</div></div>`;this.lc(i);this._('m').style.display='block';document.body.style.overflow='hidden'},lc:async function(i){const l=this._('l');if(!l)return;l.innerHTML='<div class="d">...</div>';try{const c=await this.gc(i);l.innerHTML=c.length?c.map(c=>`<div class="m">${this.sh(c.author)} ¬∑ ${this.dt(c.timestamp)}<br>${c.text}</div>`).join(''):'No comments'}catch{l.innerHTML='Failed'}},sh:function(a){return a?.length>10?a.slice(0,6)+'...'+a.slice(-4):a||'-'},dt:function(t){return new Date(t).toLocaleString('en',{month:'numeric',day:'numeric',year:'numeric',hour:'numeric',minute:'numeric'})},t:function(m){const o=this._('o');o.textContent=m;o.style.display='block';setTimeout(()=>o.style.display='none',3e3)},g:function(s){const l=this._('loadingOverlay');l&&(l.style.display=s?'flex':'none')},hm:function(){this._('m').style.display='none';document.body.style.overflow='';const t=this._('t');t&&(t.value='')}};(new A).setup();
