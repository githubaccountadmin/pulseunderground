<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>News Reporter</title><script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script><style>body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f0f0f0}#app{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1)}button{padding:8px 16px;margin:5px;cursor:pointer;border:none;border-radius:4px;background:#007bff;color:white}button:disabled{background:#ccc;cursor:not-allowed}#reportContent{width:100%;height:100px;margin:10px 0;padding:10px;border:1px solid #ddd;border-radius:4px}.report-item{border-bottom:1px solid #eee;padding:10px 0}.report-actions{margin-top:5px}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}.modal-content{background:white;padding:20px;border-radius:8px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;position:relative}.x{position:absolute;top:10px;right:10px;background:#dc3545}.comments-list{margin:10px 0}.i{display:flex;gap:10px}#t{flex:1;padding:10px;border:1px solid #ddd;border-radius:4px}#o{display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#28a745;color:white;padding:10px 20px;border-radius:4px}#loadingOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;color:white;font-size:20px}</style></head><body><div id="app"><h1>News Reporter</h1><div id="walletInfo" style="display:none">Wallet: <span id="walletAddress"></span></div><button id="connectWallet" data-connected="false">Connect Wallet</button><textarea id="reportContent" placeholder="Connect wallet to report"></textarea><button id="publishStory" disabled>Publish Story</button><button id="search-button">Search</button><div id="newsFeed"></div><button id="loadMoreButton" style="display:none">Load More</button></div><div id="loadingOverlay">Loading...</div><script>const ethers=window.ethers,{utils}=ethers,D={A:"0xD9157453E2668B2fc45b7A803D3FEF3642430cC0",B:[{inputs:[{name:"_queryId",type:"bytes32"},{name:"_value",type:"bytes"},{name:"_nonce",type:"uint256"},{name:"_queryData",type:"bytes"}],name:"submitValue",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{name:"_queryId",type:"bytes32"}],name:"getNewValueCountbyQueryId",outputs:[{name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getStakeAmount",outputs:[{name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{name:"_stakerAddress",type:"address"}],name:"getStakerInfo",outputs:[{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"bool"}],stateMutability:"view",type:"function"}],u:"api.scan.pulsechain.com/api/v2/addresses/",b:100,m:10,r:3,t:3e5,c:"0x434F4D4D454E54"},governanceContractAddress="0x51d4088d4EeE00Ae4c55f46E0673e9997121DB00",tokenContractAddress="0x7CdD7A0963A92bA1D98f6173214563EE0EBd9921",governanceContractABI=[{inputs:[{name:"_queryId",type:"bytes32"},{name:"_timestamp",type:"uint256"}],name:"beginDispute",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"disputeFee",outputs:[{name:"",type:"uint256"}],stateMutability:"view",type:"function"}],tokenABI=["function approve(address spender, uint256 amount) public returns (bool)"],C={n:"PUCache",v:1,s:{n:"news",c:"comments",r:"reporters"},t:3e5,k:{c:"cached",t:"timestamp",q:"queryId",r:"reporter"}};const sh=a=>a?.length>10?`${a.slice(0,6)}...${a.slice(-4)}`:a||"-",dt=t=>new Date(t).toLocaleString("en",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"}),displayStatus=m=>{const o=document.getElementById("o");o.textContent=m,o.style.display="block",setTimeout(()=>(o.style.display="none"),3e3)},toggleLoading=s=>document.getElementById("loadingOverlay").style.display=s?"flex":"none",hideModal=()=>{document.getElementById("m").style.display="none",document.body.style.overflow="",document.getElementById("t").value=""};class Cache{constructor(){this.name=`${C.n}:${C.v}`}async init(){this.db=await indexedDB.open(this.name,C.v);this.db.onupgradeneeded=e=>{const db=e.target.result;["news","comments","reporters"].forEach(s=>db.createObjectStore(s,{keyPath:"id"}))};return new Promise((r,j)=>{this.db.onsuccess=()=>r(this.db.result),this.db.onerror=()=>j(this.db.error)})}async get(s,k){const t=await this.transaction(s,"readonly");return new Promise((r,j)=>{const g=t.get(k);g.onsuccess=()=>r(g.result),g.onerror=()=>j(g.error)})}async set(s,k,v){const t=await this.transaction(s);return new Promise((r,j)=>{const p=t.put({id:k,...v});p.onsuccess=()=>r(),p.onerror=()=>j(p.error)})}async transaction(s,m="readwrite"){await this.db;return this.db.result.transaction(s,m).objectStore(s)}}class App{constructor(){this.e=ethers;this.state={items:[],loading:false,noMore:false,page:null,requests:new Set(),lastUpdate:0,searchActive:false};this.$=document.getElementById.bind(document);this.setup();this.cache=new Cache();this.cache.init().then(()=>this.fetch(true)).catch(console.error)}setup(){document.body.insertAdjacentHTML("beforeend",'<div id="m" class="modal"><div id="n" class="modal-content"><button class="x">Ã—</button><div id="r" class="original-post"></div><div id="s" class="comments-section"><div id="l" class="comments-list"></div><div class="i"><textarea id="t" placeholder="Write a comment..."></textarea><button id="cs">ðŸ’¬</button></div></div></div></div><div id="o" class="status-message"></div>');document.addEventListener("click",e=>{const t=e.target;if(!t)return;if(t.classList.contains("x"))hideModal();else if(t.matches(".action-btn")){const a=t.closest(".report-actions")?.dataset;if(a)t.dataset.action==="comment"?this.showCommentModal(a.queryId):t.dataset.action==="dispute"&&this.disputeNews(a.reporter,a.queryId,a.timestamp)}else switch(t.id){case"publishStory":this.publishStory();break;case"loadMoreButton":this.loadMore();break;case"cs":this.postComment();break;case"search-button":this.search()}});const btn=this.$("connectWallet");btn.addEventListener("click",()=>btn.dataset.connected==="true"?this.disconnectWallet():this.connectWallet());if(localStorage.getItem("walletConnected")==="true")this.connectWallet().catch(()=>{localStorage.removeItem("walletConnected"),btn.textContent="Connect Wallet",btn.dataset.connected="false"});else{btn.textContent="Connect Wallet",btn.dataset.connected="false"}window.ethereum.on("accountsChanged",accounts=>accounts.length===0&&this.disconnectWallet());window.ethereum.on("chainChanged",chainId=>parseInt(chainId,16)!==369&&(this.disconnectWallet(),displayStatus("Switched to unsupported network. Please reconnect on PulseChain.")))}async connectWallet(){try{if(!window.ethereum)throw new Error("No MetaMask");const provider=new this.e.providers.Web3Provider(window.ethereum);if(!(await provider.listAccounts()).length)await provider.send("eth_requestAccounts",[]);const signer=provider.getSigner(),address=await signer.getAddress(),network=await provider.getNetwork();if(network.chainId!==369){try{await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x171"}]});await new Promise(r=>window.ethereum.once("chainChanged",r));if((await provider.getNetwork()).chainId!==369)throw new Error("Failed to switch to PulseChain")}catch(e){throw new Error("Please switch to PulseChain")}}Object.assign(this,{contract:new this.e.Contract(D.A,D.B,signer),signer});const btn=this.$("connectWallet");["walletInfo"].forEach(id=>this.$(id).style.display="block");this.$("walletAddress").textContent=sh(address);this.$("publishStory").disabled=false;this.$("reportContent").placeholder="What's happening?";localStorage.setItem("walletConnected","true");btn.textContent="Disconnect Wallet";btn.dataset.connected="true";displayStatus("Connected")}catch(e){console.error("Wallet error:",e);displayStatus(e.message||"Failed to connect wallet");throw e}}disconnectWallet(){localStorage.removeItem("walletConnected");this.contract=this.signer=null;["walletInfo"].forEach(id=>this.$(id).style.display="none");this.$("publishStory").disabled=true;this.$("reportContent").placeholder="Connect wallet to report";const btn=this.$("connectWallet");btn.textContent="Connect Wallet";btn.dataset.connected="false";displayStatus("Disconnected")}async publishStory(){if(!this.signer)return displayStatus("Wallet not connected");const content=this.$("reportContent").value.trim();if(!content)return displayStatus("Please enter a story");toggleLoading(true);try{const queryData=utils.hexlify(utils.toUtf8Bytes(content)),queryId=utils.keccak256(queryData);let nonce=await this.contract.getNewValueCountbyQueryId(queryId);const value=defaultAbiCoder.encode(["string"],[content]);const tx=await this.contract.submitValue(queryId,value,nonce,queryData);await tx.wait();this.$("reportContent").value="";displayStatus("Story published successfully");this.cache.set(C.s.n,queryId,{content,timestamp:Date.now(),reporter:await this.signer.getAddress(),queryId});this.fetch(true)}catch(e){console.error("Publish error:",e);displayStatus("Failed to publish story")}finally{toggleLoading(false)}}async fetch(r=false){if(this.state.loading||this.state.noMore)return;this.state.loading=true;toggleLoading(true);try{const n=this.state.items.length;const res=await fetch(`${D.u}${D.A}/events?limit=${D.b}&offset=${n}&event=topics=${this.e.utils.id("NewReport(bytes32,address,string)")}`);const{items}=await res.json();if(!items.length)this.state.noMore=true;else{const news=await Promise.all(items.map(async i=>{const queryId=i.topics[1],reporter=i.topics[2].slice(-40),timestamp=parseInt(i.timestamp)*1e3;const cached=await this.cache.get(C.s.n,queryId);if(cached&&!r&&Date.now()-cached.timestamp<C.t)return cached;const content=defaultAbiCoder.decode(["string"],i.data)[0];const d={id:`${queryId}-${timestamp}`,content,timestamp,reporter,queryId};await this.cache.set(C.s.n,queryId,d);return d}));this.state.items=r?news:[...this.state.items,...news];this.render()}this.$("loadMoreButton").style.display=this.state.noMore?"none":"block"}catch(e){console.error("Fetch error:",e);displayStatus("Failed to load news")}this.state.loading=false;toggleLoading(false)}render(){const feed=this.$("newsFeed");feed.innerHTML=this.state.items.map(i=>`<div class="report-item"><p>${i.content.replace(/</g,"<")}</p><small>By ${sh(i.reporter)} on ${dt(i.timestamp)}</small><div class="report-actions" data-query-id="${i.queryId}" data-reporter="${i.reporter}" data-timestamp="${i.timestamp}"><button class="action-btn" data-action="comment">Comment</button><button class="action-btn" data-action="dispute">Dispute</button></div></div>`).join("")}async loadMore(){this.state.page=(this.state.page||0)+1;await this.fetch()}async showCommentModal(queryId){const item=this.state.items.find(i=>i.queryId===queryId);if(!item)return;this.$("r").innerHTML=`<p>${item.content.replace(/</g,"<")}</p><small>By ${sh(item.reporter)} on ${dt(item.timestamp)}</small>`;this.$("l").innerHTML=(await this.getComments(queryId)).map(c=>`<div><p>${c.content.replace(/</g,"<")}</p><small>By ${sh(c.reporter)} on ${dt(c.timestamp)}</small></div>`).join("");this.$("m").dataset.queryId=queryId;this.$("m").style.display="flex";document.body.style.overflow="hidden"}async getComments(queryId){const cached=await this.cache.get(C.s.c,queryId);if(cached&&Date.now()-cached.timestamp<C.t)return cached.comments;const res=await fetch(`${D.u}${D.A}/events?limit=${D.b}&event=topics=${D.c}&topics=${queryId}`);const{items}=await res.json();const comments=items.map(i=>({content:defaultAbiCoder.decode(["string"],i.data)[0],timestamp:parseInt(i.timestamp)*1e3,reporter:i.topics[2].slice(-40),queryId}));await this.cache.set(C.s.c,queryId,{comments,timestamp:Date.now()});return comments}async postComment(){if(!this.signer)return displayStatus("Wallet not connected");const content=this.$("t").value.trim(),queryId=this.$("m").dataset.queryId;if(!content||!queryId)return displayStatus("Please enter a comment");toggleLoading(true);try{const value=defaultAbiCoder.encode(["string"],[content]),tx=await this.contract.submitValue(queryId,value,0,D.c);await tx.wait();hideModal();displayStatus("Comment posted successfully");this.cache.set(C.s.c,queryId,{comments:[...(await this.getComments(queryId)),{content,timestamp:Date.now(),reporter:await this.signer.getAddress(),queryId}],timestamp:Date.now()});this.showCommentModal(queryId)}catch(e){console.error("Comment error:",e);displayStatus("Failed to post comment")}toggleLoading(false)}async disputeNews(reporter,queryId,timestamp){if(!this.signer)return displayStatus("Wallet not connected");toggleLoading(true);try{const token=new this.e.Contract(tokenContractAddress,tokenABI,this.signer);const governance=new this.e.Contract(governanceContractAddress,governanceContractABI,this.signer);const fee=await governance.disputeFee();await(await token.approve(governanceContractAddress,fee)).wait();await(await governance.beginDispute(queryId,timestamp)).wait();displayStatus("Dispute initiated successfully")}catch(e){console.error("Dispute error:",e);displayStatus("Failed to initiate dispute")}toggleLoading(false)}search(){this.state.searchActive=true;this.state.items=[];this.state.noMore=false;this.fetch(true)}}new App()</script></body></html>
