<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Pulse Underground</title><link rel="icon" type="image/jpeg" href="newTRBphoto.jpg"><script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script><style>:root{--primary:#7c4dff;--primary-light:#b388ff;--bg-dark:#0d0b14;--bg-light:#13101c;--bg-lighter:#1a1327;--border:#2a2438;--border-hover:#38314d;--text:#fff;--text-secondary:#8899a6}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg-dark);color:var(--text);line-height:1.3}#app-container{display:flex;min-height:100vh;max-width:1280px;margin:0 auto;background:var(--bg-dark)}#sidebar-left,#sidebar-right{position:sticky;top:0;height:100vh;overflow-y:auto;background:var(--bg-light)}#sidebar-left{width:275px;padding:0 12px;display:flex;flex-direction:column;border-right:1px solid var(--border)}#sidebar-left h1{font-size:24px;color:var(--primary-light);margin:0 0 20px;padding-left:12px}nav ul{list-style:none;padding:0;margin:0}nav ul li{margin-bottom:8px}nav ul li a{display:flex;align-items:center;color:var(--text);text-decoration:none;padding:10px 12px;border-radius:8px;transition:background .2s;font-size:16px}nav ul li a:hover{background:var(--border)}nav ul li a .icon{margin-right:16px;font-size:20px}.sidebar-content{display:flex;flex-direction:column;flex-grow:1;padding-top:12px}.bottom-buttons{padding:12px 0;margin-top:auto}#postButton,#connectWallet{width:100%;padding:12px;border:none;border-radius:8px;background:linear-gradient(45deg,var(--primary),var(--primary-light));color:var(--text);font-size:16px;font-weight:700;cursor:pointer;transition:background .3s;display:block;margin-bottom:12px}#postButton:hover,#connectWallet:hover{background:linear-gradient(45deg,#6a3fff,#a370ff)}main{flex-grow:1;max-width:600px;border-left:1px solid var(--border);border-right:1px solid var(--border);background:var(--bg-light)}#tab-container{display:flex;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-light);z-index:1}.tab{flex:1;padding:16px;background:none;border:none;color:var(--text);font-weight:700;cursor:pointer;text-align:center}.tab.active{border-bottom:4px solid var(--primary)}#storySubmission{display:flex;padding:16px;border-bottom:1px solid var(--border);background:var(--bg-lighter)}.avatar{width:48px;height:48px;border-radius:50%;margin-right:12px}.input-container{flex-grow:1;position:relative}#reportContent{width:100%;min-height:80px;padding:12px;background:var(--bg-light);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;resize:none}#reportContent:focus{outline:none;border-color:var(--primary)}#publishStory{position:absolute;bottom:8px;right:8px;width:34px;height:34px;border-radius:50%;background:linear-gradient(45deg,var(--primary),var(--primary-light));border:none;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center}#publishStory:disabled{opacity:.5;cursor:not-allowed}#sidebar-right{width:350px;padding:16px;border-left:1px solid var(--border)}#search-container{position:relative;margin-bottom:16px}#search-input{width:100%;padding:12px 40px 12px 44px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:999px;color:var(--text);font-size:15px}#search-input:focus{outline:none;border-color:var(--primary);background:var(--border)}#search-button{position:absolute;left:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--primary-light);font-size:16px;cursor:pointer}#trending-section,#who-to-follow,#disputes-section{background:var(--bg-lighter);border-radius:12px;padding:16px;margin-bottom:16px}h3{margin:0;padding-bottom:12px;font-size:20px;color:var(--primary-light);border-bottom:1px solid var(--border)}#newsFeed article{padding:16px;border-bottom:1px solid var(--border);transition:background .2s}#newsFeed article:hover{background:var(--bg-lighter)}.reporter-info{display:flex;align-items:flex-start;margin-bottom:8px}.reporter-details{flex-grow:1;margin-left:12px}.reporter-name{font-weight:700}.report-content{margin:8px 0;line-height:1.4}.report-actions{display:flex;justify-content:space-between;margin-top:12px;padding-top:8px;border-top:1px solid var(--border)}.action-btn{background:none;border:none;color:var(--primary-light);padding:4px 8px;border-radius:4px;cursor:pointer;transition:background .2s}.action-btn:hover{background:rgba(179,136,255,.1);color:var(--text)}.modal{display:none;position:fixed;inset:0;z-index:1000}.modal-content{position:absolute;top:5vh;left:50%;transform:translateX(-50%);width:600px;max-height:90vh;background:var(--bg-light);border-radius:16px;overflow:hidden;border:1px solid var(--border)}.x{position:absolute;right:12px;top:12px;background:none;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer;z-index:2;transition:color .2s}.x:hover{color:var(--text)}.original-post{padding:16px;border-bottom:1px solid var(--border);background:var(--bg-light)}.original-post .reporter-info{display:flex;align-items:center;margin-bottom:12px}.original-post .avatar{width:48px;height:48px;border-radius:50%;margin-right:12px}.original-post .reporter-details{display:flex;flex-direction:column}.original-post .reporter-name{font-weight:700;margin-bottom:4px}.original-post .report-timestamp{color:var(--text-secondary);font-size:.9em}.original-post .report-content{font-size:16px;line-height:1.5;margin:12px 0;white-space:pre-wrap;word-wrap:break-word}.comments-section{background:var(--bg-light)}.comments-list{padding:0 16px;max-height:50vh;overflow-y:auto}.comment{padding:12px 0;border-bottom:1px solid var(--border)}.comment-header{display:flex;align-items:center;margin-bottom:8px}.comment-header img{width:32px;height:32px;border-radius:50%;margin-right:8px}.comment-text{color:var(--text);line-height:1.4}.comment-input{padding:16px;border-top:1px solid var(--border);background:var(--bg-light)}#t{width:100%;min-height:100px;padding:12px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;resize:vertical;margin-bottom:12px}#t:focus{outline:none;border-color:var(--primary)}#cs{background:var(--primary);color:var(--text);border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:700;float:right}#cs:hover{background:#6a3fff}#cs:disabled{opacity:.5}#loadingOverlay,#o{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(26,19,39,.8);color:var(--text);padding:10px 20px;border-radius:20px;z-index:1000;display:none}#loadingOverlay{align-items:center}#loadingOverlay::after{content:'';width:20px;height:20px;margin-left:10px;border:2px solid var(--primary-light);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}@media(max-width:1200px){#sidebar-right{width:290px}}@media(max-width:800px){#sidebar-left{width:68px;padding:0 4px}#sidebar-left h1{font-size:0}#sidebar-left h1::before{content:"PU";font-size:18px}nav ul li a span:not(.icon){display:none}#postButton,#connectWallet{width:50px;height:50px;border-radius:50%;font-size:0;padding:0}#postButton::after{content:"+";font-size:22px}#connectWallet::after{content:"üîó";font-size:22px}main{max-width:calc(100% - 68px)}.modal-content{width:95%;max-width:600px}}</style></head><body><div id="app-container"><div id="sidebar-left"><div class="sidebar-content"><h1>Pulse Underground</h1><nav><ul><li><a href="#"><span class="icon">üè†</span> Home</a></li><li><a href="#"><span class="icon">üîç</span> Explore</a></li><li><a href="#"><span class="icon">üîî</span> Notifications</a></li><li><a href="#"><span class="icon">‚úâÔ∏è</span> Messages</a></li><li><a href="#"><span class="icon">üë§</span> Profile</a></li><li><a href="#"><span class="icon">‚ãØ</span> More</a></li></ul></nav></div><div class="bottom-buttons"><button id="postButton">Post</button><button id="connectWallet">Connect Wallet</button></div><div id="profile-section"><div id="walletInfo" style="display:none"><span id="walletAddress"></span></div></div></div><main><div id="tab-container"><div class="tab active">All Reporters</div><div class="tab">Reporters you follow</div></div><div id="storySubmission"><img src="newTRBphoto.jpg" alt="User Avatar" class="avatar"><div class="input-container"><textarea id="reportContent" placeholder="Connect wallet to report"></textarea><button id="publishStory" disabled>‚û§</button></div></div><div id="newsFeed"></div><button id="loadMoreButton">Load More</button></main><div id="sidebar-right"><div id="search-container"><input type="text" id="search-input" placeholder="Search The Pulse Underground"><button id="search-button">üîç</button></div><div id="trending-section"><h3>What's happening</h3></div><div id="who-to-follow"><h3>Who to follow</h3></div><div id="disputes-section"><h3>Disputes</h3></div></div></div><div id="m" class="modal"><div id="n" class="modal-content"><button class="x">√ó</button><div id="r" class="original-post"></div><div id="s" class="comments-section"><div id="l" class="comments-list"></div><div class="comment-input"><textarea id="t" placeholder="Write a comment..."></textarea><button id="cs">üí¨</button></div></div></div></div><div id="loadingOverlay">Loading news feed...</div><div id="o"></div><script>const ethers=window.ethers;if(!ethers){console.error("Ethers.js not loaded");alert("Error: Ethers.js not loaded")}const{utils}=ethers,D={A:"0xD9157453E2668B2fc45b7A803D3FEF3642430cC0",B:[{inputs:[{name:"_queryId",type:"bytes32"},{name:"_value",type:"bytes"},{name:"_nonce",type:"uint256"},{name:"_queryData",type:"bytes"}],name:"submitValue",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{name:"_queryId",type:"bytes32"}],name:"getNewValueCountbyQueryId",outputs:[{name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getStakeAmount",outputs:[{name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{name:"_stakerAddress",type:"address"}],name:"getStakerInfo",outputs:[{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"uint256"},{name:"",type:"bool"}],stateMutability:"view",type:"function"}],u:"api.scan.pulsechain.com/api/v2/addresses/",b:100,m:10,r:3,t:3e5,c:"0x434F4D4D454E54"},governanceContractAddress="0x51d4088d4EeE00Ae4c55f46E0673e9997121DB00",tokenContractAddress="0x7CdD7A0963A92bA1D98f6173214563EE0EBd9921",governanceContractABI=[{inputs:[{name:"_queryId",type:"bytes32"},{name:"_timestamp",type:"uint256"}],name:"beginDispute",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"disputeFee",outputs:[{name:"",type:"uint256"}],stateMutability:"view",type:"function"}],tokenABI=["function approve(address spender, uint256 amount) public returns (bool)"],C={n:"PUCache",v:1,s:{n:"news",c:"comments",r:"reporters"},t:3e5,k:{c:"cached",t:"timestamp",q:"queryId",r:"reporter"}};function sh(a){return a?.length>10?a.slice(0,6)+"..."+a.slice(-4):a||"-"}function dt(t){return new Date(t).toLocaleString("en",{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"})}function displayStatus(m){console.log("Status:",m);const o=document.getElementById("o");o.textContent=m;o.style.display="block";setTimeout(()=>(o.style.display="none"),3e3)}function toggleLoading(s){console.log("Toggle loading:",s);const l=document.getElementById("loadingOverlay");l&&(l.style.display=s?"flex":"none")}function hideModal(){console.log("Hiding modal");document.getElementById("m").style.display="none";document.body.style.overflow="";const t=document.getElementById("t");t&&(t.value="")}class Cache{constructor(){this.db=null;this.memoryCache=new Map();this.pendingRequests=new Set();console.log("Initializing Cache");this.init()}async init(){if(this.db){console.log("DB already initialized");return this.db}console.log("Opening IndexedDB");return new Promise((r,j)=>{const o=indexedDB.open(C.n,C.v);o.onerror=()=>{console.error("IndexedDB error:",o.error);j(o.error)};o.onsuccess=()=>{console.log("IndexedDB opened");this.db=o.result;r(this.db)};o.onupgradeneeded=e=>{console.log("Upgrading DB");const d=e.target.result,k=C.k;if(!d.objectStoreNames.contains(C.s.n)){console.log("Creating news store");const s=d.createObjectStore(C.s.n,{keyPath:k.q});s.createIndex(k.t,k.t,{unique:false});s.createIndex(k.r,k.r,{unique:false})}}})}async transaction(s,m,c){console.log(`Transaction: ${s}, mode: ${m}`);const d=await this.init(),t=d.transaction(s,m),store=t.objectStore(s);try{console.log("Executing transaction");return await c(store,t)}catch(e){console.error("Transaction failed:",e);t.abort();throw e}}async saveNews(i){console.log(`Saving ${i.length} news items`);const t=Date.now();await this.transaction(C.s.n,"readwrite",async s=>{console.log("In saveNews transaction");await Promise.all(i.map(item=>{console.log("Saving:",item);return s.put({...item,[C.k.c]:t})}))})}async getNews(o={}){console.log("Getting news, options:",o);const{limit=50,offset=0,reporter}=o,n=Date.now(),news=[];return this.transaction(C.s.n,"readonly",async s=>{console.log("In getNews transaction");const i=reporter?s.index(C.k.r):s.index(C.k.t);await new Promise(r=>{let c=0;i.openCursor(reporter||null,"prev").onsuccess=e=>{const cursor=e.target.result;if(!cursor||news.length>=limit){console.log("Cursor done or limit reached");r();return}if(c<offset){c++;cursor.continue();return}if(cursor.value[C.k.c]>n-C.t){console.log("Adding news:",cursor.value);news.push(cursor.value)}cursor.continue()}});console.log(`Fetched ${news.length} items`);return news})}}class App{constructor(){console.log("Starting App");this.e=ethers;this.state={items:[],loading:false,noMore:false,page:null,requests:new Set(),lastUpdate:0,searchActive:false};this.$=document.getElementById.bind(document);this.setup();this.cache=new Cache();this.cache.init().then(()=>{console.log("Fetching initial data");this.fetch(true)}).catch(e=>console.error("Init error:",e))}setup(){console.log("Setting up event listeners");document.addEventListener("click",e=>{const t=e.target;if(!t)return;if(t.classList.contains("x"))this.hideModal();else if(t.matches(".action-btn")){const a=t.closest(".report-actions")?.dataset;if(a){if(t.dataset.action==="comment")this.showCommentModal(a.queryId);else if(t.dataset.action==="dispute")this.disputeNews(a.reporter,a.queryId,a.timestamp)}}else switch(t.id){case"connectWallet":this.signer?this.disconnectWallet():this.connectWallet();break;case"publishStory":this.publishStory();break;case"loadMoreButton":this.loadMore();break;case"cs":this.postComment();break;case"search-button":this.search()}});const textarea=this.$("t");if(textarea)new ResizeObserver(()=>(textarea.style.height=textarea.scrollHeight+"px")).observe(textarea);const si=this.$("search-input");if(si){si.addEventListener("keypress",e=>e.key==="Enter"&&this.search());si.addEventListener("input",e=>{if(!e.target.value.trim()&&this.state.searchActive){this.state.searchActive=false;this.render(this.state.items);this.$("loadMoreButton").style.display="none"}})}window.addEventListener("scroll",()=>{if(!this.state.loading&&!this.state.noMore&&!this.state.searchActive&&window.innerHeight+window.scrollY>=document.documentElement.scrollHeight-500)this.loadMore()});this.$("loadMoreButton").style.display="none";setInterval(()=>{console.log("Periodic loadMore");this.loadMore()},D.t);if(localStorage.getItem("walletConnected")==="true"&&window.ethereum){this.connectWallet().catch(()=>{localStorage.removeItem("walletConnected");this.$("connectWallet").style.display="block";this.$("walletInfo").style.display="none";this.$("publishStory").disabled=true;this.$("reportContent").placeholder="Connect wallet to report";displayStatus("Failed to reconnect wallet")})}window.ethereum.on("accountsChanged",(accounts)=>{if(accounts.length===0){this.disconnectWallet()}else{this.$("walletAddress").textContent=sh(accounts[0])}});window.ethereum.on("chainChanged",(chainId)=>{if(parseInt(chainId,16)!==369){this.disconnectWallet();displayStatus("Switched to unsupported network. Please reconnect on PulseChain.")}})}async connectWallet(){console.log("Connecting wallet");try{if(!window.ethereum)throw new Error("No MetaMask");const p=new this.e.providers.Web3Provider(window.ethereum),n=await p.getNetwork();if(n.chainId!==369){try{await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x171"}] })}catch(e){throw new Error("Switch to PulseChain (369)")}}await p.send("eth_requestAccounts",[]);const s=p.getSigner(),a=await s.getAddress();console.log("Connected address:",a);this.$("connectWallet").style.display="none";this.$("walletInfo").style.display="block";this.$("walletAddress").textContent=sh(a);this.$("publishStory").disabled=false;this.$("reportContent").placeholder="What's happening?";this.contract=new this.e.Contract(D.A,D.B,s);this.signer=s;localStorage.setItem("walletConnected","true");displayStatus("Connected")}catch(e){console.error("Wallet connection failed:",e);displayStatus(e.message||"Failed to connect")}}disconnectWallet(){this.signer=null;this.contract=null;this.$("connectWallet").style.display="block";this.$("walletInfo").style.display="none";this.$("publishStory").disabled=true;this.$("reportContent").placeholder="Connect wallet to report";localStorage.removeItem("walletConnected");displayStatus("Disconnected")}async publishStory(){console.log("Publishing story");const c=this.$("reportContent").value.trim();if(!c)return displayStatus("No content");if(!this.contract)return displayStatus("Wallet not connected");this.$("publishStory").disabled=true;toggleLoading(true);try{const d=utils.defaultAbiCoder.encode(["string","bytes"],["StringQuery",utils.toUtf8Bytes(c)]),q=utils.keccak256(d),n=await this.contract.getNewValueCountbyQueryId(q),v=utils.defaultAbiCoder.encode(["string","bytes"],["NEWS",utils.toUtf8Bytes(c)]);const si=await this.contract.getStakerInfo(await this.signer.getAddress()),rs=await this.contract.getStakeAmount();if(si[1].lt(rs))throw new Error(`Insufficient stake: ${utils.formatEther(si[1])}/${utils.formatEther(rs)} TRB`);let g;try{g=await this.contract.estimateGas.submitValue(q,v,n,d)}catch(e){console.warn("Gas estimation failed:",e);g=this.e.BigNumber.from("300000")}const gl=g.mul(110).div(100),tx=await this.contract.submitValue(q,v,n,d,{gasLimit:gl}),r=await tx.wait();console.log("Story published, tx:",tx.hash);displayStatus("Story published! Tx: "+tx.hash);const ns={content:c,reporter:await this.signer.getAddress(),timestamp:new Date().toISOString(),queryId:q};this.state.items.unshift(ns);this.render([ns],true);await this.cache.saveNews([ns]);this.$("reportContent").value=""}catch(e){console.error("Publish failed:",e);displayStatus(e.message||"Failed to publish")}finally{this.$("publishStory").disabled=false;toggleLoading(false)}}search(){console.log("Searching");const i=this.$("search-input"),v=i?.value.trim().toLowerCase();if(!v)return;const f=this.state.items.filter(item=>sh(item.reporter).toLowerCase().includes(v)||item.content.toLowerCase().includes(v));this.render(f);this.state.searchActive=true;this.$("loadMoreButton").style.display="block";displayStatus(`Found ${f.length} result(s)`)}async loadMore(){if(this.state.loading||Date.now()-this.state.lastUpdate<3e4)return;console.log("Loading more");this.state.loading=true;toggleLoading(true);try{const t=await this.fetchTransactions(this.state.page),n=await this.parseTransactions(t),f=n.filter(i=>!this.state.items.some(e=>e.queryId===i.queryId));if(f.length){this.state.items.unshift(...f);this.render(f,true);displayStatus("+"+f.length);await this.cache.saveNews(f)}this.state.lastUpdate=Date.now()}catch(e){console.error("Load more failed:",e)}finally{this.state.loading=false;toggleLoading(false)}}async fetch(i){console.log("Fetching news, initial:",i);if(this.state.loading||this.state.noMore&&!i)return;this.state.loading=true;toggleLoading(true);if(i){this.state.items=[];this.state.noMore=false;this.state.page=null}try{const ci=await this.cache.getNews({limit:D.m});if(ci.length){this.state.items=ci;this.render(ci,!i)}const items=[];while(items.length<D.m&&!this.state.noMore){const t=await this.fetchTransactions(this.state.page);items.push(...(await this.parseTransactions(t)))}if(items.length){await this.cache.saveNews(items);this.state.items=i?items:this.state.items.concat(items);this.render(items,!i)}this.$("loadMoreButton").style.display=this.state.noMore?"none":"block"}catch(e){console.error("Fetch error:",e)}finally{this.state.loading=false;toggleLoading(false)}}async parseTransactions(b){console.log("Parsing transactions");if(!b?.items?.length){this.state.noMore=true;return[]}const items=[];for(const tx of b.items)if(tx.method==="submitValue"&&tx.decoded_input?.parameters?.length>=4){const[t,d]=utils.defaultAbiCoder.decode(["string","bytes"],tx.decoded_input.parameters[3].value);if(t==="StringQuery"){const c=utils.toUtf8String(d).trim();if(c)items.push({content:c,reporter:tx.from.hash||tx.from,timestamp:tx.timestamp||tx.block_timestamp,queryId:tx.decoded_input.parameters[0].value})}}this.state.page=b.next_page_params||null;this.state.noMore=!this.state.page;console.log(`Parsed ${items.length} items`);return items}render(i,a=false){console.log("Rendering items, append:",a);if(!i.length&&!a)return this.$("newsFeed").innerHTML="No items";const f=document.createDocumentFragment(),t=document.createElement("template");i.forEach(item=>{t.innerHTML=`<article class="news-item"><div class="reporter-info"><img src="newTRBphoto.jpg" alt="R" class="avatar"><div class="reporter-details"><span class="reporter-name">${sh(item.reporter)}</span>¬∑ ${dt(item.timestamp)}</div></div><div class="report-content">${item.content.split("\n\n").map(p=>"<p>"+p.replace(/\n/g,"<br>")+"</p>").join("")}</div><div class="report-actions" data-reporter="${item.reporter}" data-query-id="${item.queryId}" data-timestamp="${item.timestamp}"><button class="action-btn" data-action="comment">üí¨</button><button class="action-btn" data-action="like">üëç</button><button class="action-btn" data-action="dispute">‚ö†Ô∏è</button><button class="action-btn" data-action="vote">‚úì</button></div></article>`;f.appendChild(t.content.firstChild)});const feed=this.$("newsFeed");a?feed.appendChild(f):(feed.textContent="",feed.appendChild(f));feed.style.visibility="visible"}async fetchTransactions(p){console.log("Fetching transactions, params:",p);const u=`https://${D.u}${D.A}/transactions?filter=to&sort=desc&limit=${D.b}${p?"&"+new URLSearchParams(p):""}`;if(this.state.requests.has(u))return this.state.cachedResponses.get(u);this.state.requests.add(u);try{const r=await fetch(u);if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();this.state.cachedResponses=this.state.cachedResponses||new Map();this.state.cachedResponses.set(u,d);console.log("Fetched transactions:",d.items.length);return d}catch(e){console.error("Fetch transactions failed:",e);throw e}finally{this.state.requests.delete(u)}}async initializeEthers(){console.log("Initializing Ethers");if(!window.ethereum)throw new Error("No Ethereum provider");const p=new ethers.providers.Web3Provider(window.ethereum);await p.send("eth_requestAccounts",[]);const s=p.getSigner();this.governanceContract=new ethers.Contract(governanceContractAddress,governanceContractABI,s);this.tokenContract=new ethers.Contract(tokenContractAddress,tokenABI,s);return{p,s}}async getDisputeFee(){console.log("Getting dispute fee");const{p}=await this.initializeEthers(),n=await p.getNetwork();if(n.chainId!==369)throw new Error("Switch to PulseChain");return this.governanceContract.disputeFee()}async beginDispute(q,t){console.log("Beginning dispute, queryId:",q);try{const{p}=await this.initializeEthers(),n=await p.getNetwork();if(n.chainId!==369)throw new Error("Switch to PulseChain");const f=await this.getDisputeFee(),a=await this.tokenContract.approve(governanceContractAddress,f);await a.wait();console.log("Approval tx confirmed");const tx=await this.governanceContract.beginDispute(q,t);await tx.wait();console.log("Dispute tx confirmed");return tx.hash}catch(e){console.error("Dispute error:",e);if(e.message.includes("insufficient funds"))throw new Error("Insufficient TRB");throw e}}async disputeNews(r,q,t){console.log("Disputing news, reporter:",r);try{const f=await this.getDisputeFee();if(confirm(`Dispute this?\nReporter: ${sh(r)}\nFee: ${utils.formatEther(f)} TRB`)){toggleLoading(true);const tx=await this.beginDispute(q,t);displayStatus(`Dispute submitted! Tx: ${tx}`)}}catch(e){displayStatus(`Dispute failed: ${e.message}`)}finally{toggleLoading(false)}}showCommentModal(q){console.log("Showing comment modal for queryId:",q)}postComment(){console.log("Posting comment")}hideModal=hideModal}new App()</script></body></html>
