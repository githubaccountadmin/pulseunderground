<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Pulse Underground</title><link rel="icon" type="image/jpeg" href="image1.jpeg"><script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script><style>:root{--primary:#7c4dff;--primary-light:#b388ff;--bg-dark:#0d0b14;--bg-light:#13101c;--bg-lighter:#1a1327;--border:#2a2438;--text:#fff;--neon-glow:0 0 5px var(--primary),0 0 10px var(--primary),0 0 15px var(--primary)}*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg-dark);color:var(--text);line-height:1.5;font-size:16px}#app-container{display:flex;min-height:100vh;max-width:1280px;margin:0 auto}#sidebar-left,#sidebar-right{position:sticky;top:0;height:100vh;background:var(--bg-light);padding:20px;overflow-y:auto}#sidebar-left{width:250px;border-right:1px solid var(--border)}#sidebar-right{width:300px;border-left:1px solid var(--border)}.logo{display:block;margin:0 auto 20px;width:100px}h1{font-size:24px;color:var(--primary-light);text-align:center;margin-bottom:20px}h3{font-size:18px;color:var(--primary-light);margin-bottom:15px}nav ul{list-style:none}nav ul li{margin-bottom:10px}nav a{display:flex;align-items:center;color:var(--text);text-decoration:none;padding:10px;border-radius:8px}nav a:hover,button:hover{background:linear-gradient(45deg,#6a3fff,#a370ff);box-shadow:var(--neon-glow);transition:background .3s,box-shadow .3s}.icon{width:20px;height:20px;margin-right:15px;filter:drop-shadow(0 0 2px var(--primary))}main{flex-grow:1;padding:20px;width:calc(1280px - 550px)}button{width:100%;padding:12px;background:linear-gradient(45deg,var(--primary),var(--primary-light));color:var(--text);border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-bottom:15px}#publishStory{position:absolute;bottom:10px;right:10px;width:40px;height:40px;border-radius:50%;padding:0;display:flex;align-items:center;justify-content:center}#loadMoreButton{width:auto;padding:8px 20px;font-size:14px;margin:20px auto;display:none}button:disabled{opacity:.6;cursor:not-allowed}#storySubmission{display:flex;padding:15px;background:var(--bg-lighter);border-bottom:1px solid var(--border);margin-bottom:20px}.avatar{width:48px;height:48px;border-radius:50%;margin-right:15px}.input-container{flex-grow:1;position:relative}textarea{width:100%;min-height:100px;padding:15px;background:var(--bg-light);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:none;outline:none}textarea:focus{border-color:var(--primary);box-shadow:var(--neon-glow)}.news-item{padding:15px;border-bottom:1px solid var(--border);transition:background .2s}.news-item:hover{background:var(--bg-lighter)}.reporter-info{display:flex;align-items:center;margin-bottom:10px}.reporter-details{font-size:14px;margin-left:10px}.reporter-name{font-weight:bold}.report-content{margin:10px 0;line-height:1.6}#searchInput,#customChannelInput{width:100%;padding:12px 15px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:8px;color:var(--text);margin-bottom:20px;outline:none}#searchInput:focus,#customChannelInput:focus{border-color:var(--primary);box-shadow:var(--neon-glow)}#loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,11,20,.8);color:var(--text);display:none;justify-content:center;align-items:center;z-index:1000}#statusMessage{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg-light);padding:10px 20px;border-radius:5px;display:none;color:var(--text);z-index:1001;box-shadow:var(--neon-glow)}#profileModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,11,20,.8);display:none;justify-content:center;align-items:center;z-index:1000}.modal-content{background:var(--bg-light);padding:20px;border-radius:8px;width:400px;max-width:90%;border:1px solid var(--border)}.modal-content h2{color:var(--primary-light);margin-bottom:20px}.modal-content input{width:100%;padding:10px;margin-bottom:15px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:5px;color:var(--text);outline:none}.modal-content img{width:100px;height:100px;border-radius:50%;margin-bottom:15px;display:block;margin-left:auto;margin-right:auto}.modal-buttons{display:flex;gap:10px}</style></head><body><div id="app-container"><div id="sidebar-left"><img src="image1.jpeg" class="logo"><nav><ul><li><a id="homeLink"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" stroke="var(--primary-light)"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9zM9 22V12h6v10"></path></svg></span>Home</a></li><li><a><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" stroke="var(--primary-light)"><path d="M21 21l-6-6m2-5a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"></path></svg></span>Explore</a></li><li><a><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" stroke="var(--primary-light)"><path d="M12 22c5.5 0 10-4.5 10-10S17.5 2 12 2 2 6.5 2 12s4.5 10 10 10zM12 8v4M12 16h.01"></path></svg></span>Notifications</a></li><li><a><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" stroke="var(--primary-light)"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zM22 6l-10 7L2 6"></path></svg></span>Messages</a></li><li><a id="profileLink"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" stroke="var(--primary-light)"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 7c0 2.2-1.8 4-4 4s-4-1.8-4-4 1.8-4 4-4 4 1.8 4 4z"></path></svg></span>Profile</a></li></ul></nav><button id="connectWallet">Connect Wallet</button><div id="walletInfo" style="display:none"><span id="walletAddress"></span></div></div><main><h1>The Pulse Underground</h1><div id="storySubmission"><img src="image1.jpeg" class="avatar" id="submissionAvatar"><div class="input-container"><textarea id="reportContent" placeholder="Share a Story..."></textarea><button id="publishStory">➤</button></div></div><div id="newsFeed"></div><button id="loadMoreButton">Load More</button></main><div id="sidebar-right"><input id="searchInput" placeholder="Search Posts"><div id="channelSelection"><h3>Channels</h3><button id="mainChannel">Main</button><button id="selfChannel">Self</button><input id="customChannelInput" placeholder="Enter Custom Address"><button id="setCustomChannel">Set</button><p>Current Channel: <span id="currentChannel"></span></p></div></div></div><div id="loadingOverlay">Loading...</div><div id="statusMessage"></div><div id="profileModal"><div class="modal-content"><h2>Edit Profile</h2><img src="image1.jpeg" id="profilePicPreview"><input id="usernameInput" placeholder="Username"><input id="profilePicInput" placeholder="Profile Picture URL"><div class="modal-buttons"><button id="saveProfile">Save</button><button id="clearProfile">Clear</button><button id="closeProfileModal">Close</button></div></div></div><script>const ethers=window.ethers,MAIN_CHANNEL="0x9Cd83BE15a79646A3D22B81fc8dDf7B7240a62cB".toLowerCase(),PULSE_CHAIN_ID=369;class Cache{constructor(){this.db=null,this.dbReady=false,console.log("Cache initializing"),this.initDB().then(()=>{this.dbReady=true,console.log("Cache ready")})}async initDB(){return new Promise(r=>{const q=indexedDB.open("PulseUndergroundCache",2);q.onupgradeneeded=e=>{const d=e.target.result;d.objectStoreNames.contains("newsItems")||d.createObjectStore("newsItems",{keyPath:"txHash"}),d.objectStoreNames.contains("profiles")||d.createObjectStore("profiles",{keyPath:"address"})},q.onsuccess=()=>{this.db=q.result,r()},q.onerror=()=>{document.getElementById("statusMessage").textContent="IndexedDB Error",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}})}async waitForDB(){while(!this.dbReady)await new Promise(r=>setTimeout(r,100))}async dbOp(t,o,m,p){await this.waitForDB();if(!this.db)return console.error("DB null in",m),p?null:void 0;const s=this.db.transaction(t,"readwrite"),q=s.objectStore(t);if(m==="put")o.forEach(j=>q.put(j));else if(m==="get")return new Promise((r,e)=>{const v=q.get(o);v.onsuccess=()=>{r(v.result)},v.onerror=()=>{e(v.error)}});else if(m==="delete")q.delete(o);return new Promise((r,e)=>{s.oncomplete=r,s.onerror=()=>{e(s.error),console.error(m,"error:",s.error)}})}}class PulseUnderground{constructor(){this.state={newsItems:[],searchTerm:"",isLoading:false,nextPageParams:null,channel:MAIN_CHANNEL,profile:{username:"",profilePicUrl:"image1.jpeg"},signerAddress:null},this.elements={newsFeed:document.getElementById("newsFeed"),reportContent:document.getElementById("reportContent"),searchInput:document.getElementById("searchInput"),loadMoreButton:document.getElementById("loadMoreButton"),connectWallet:document.getElementById("connectWallet"),walletInfo:document.getElementById("walletInfo"),walletAddress:document.getElementById("walletAddress"),publishStory:document.getElementById("publishStory"),mainChannel:document.getElementById("mainChannel"),selfChannel:document.getElementById("selfChannel"),customChannelInput:document.getElementById("customChannelInput"),setCustomChannel:document.getElementById("setCustomChannel"),currentChannel:document.getElementById("currentChannel"),submissionAvatar:document.getElementById("submissionAvatar"),profileLink:document.getElementById("profileLink"),profileModal:document.getElementById("profileModal"),usernameInput:document.getElementById("usernameInput"),profilePicInput:document.getElementById("profilePicInput"),profilePicPreview:document.getElementById("profilePicPreview"),saveProfile:document.getElementById("saveProfile"),clearProfile:document.getElementById("clearProfile"),closeProfileModal:document.getElementById("closeProfileModal"),homeLink:document.getElementById("homeLink")},console.log("Elements initialized:",!!this.elements.newsFeed,!!this.elements.loadMoreButton),this.cache=new Cache,this.signer=null}async init(){console.log("Init: start");await this.cache.waitForDB(),console.log("Init: cache ready"),await this.cache.dbOp("newsItems",[],"put"),console.log("Init: cache cleared"),this.state.newsItems=(await new Promise((r,e)=>{const t=this.cache.db?.transaction("newsItems","readonly"),s=t?.objectStore("newsItems"),q=s?.getAll();q.onsuccess=()=>{r(q.result||[])},q.onerror=()=>{e(q.error)}}))||[],console.log("Init: loaded",this.state.newsItems.length,"items"),this.renderNewsFeed(),this.setupListeners(),this.elements.currentChannel.textContent=this.state.channel.slice(0,6)+"..."+this.state.channel.slice(-4),console.log("Init: fetching posts"),await this.fetchPosts(33,true)}setupListeners(){const e=this.elements,t=(f,d)=>(...a)=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{f.apply(this,a)},d)};e.connectWallet.onclick=()=>this.toggleWallet(),e.publishStory.onclick=()=>this.publishStory(),e.searchInput.oninput=t(()=>{this.state.searchTerm=e.searchInput.value.trim().toLowerCase(),this.renderNewsFeed()},300),e.loadMoreButton.onclick=()=>this.fetchPosts(this.state.newsItems.length+33,false),e.homeLink.onclick=e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})},e.mainChannel.onclick=async()=>{this.state.newsItems.length=0,this.state.nextPageParams=null,await this.cache.dbOp("newsItems",[],"put"),this.state.channel=MAIN_CHANNEL,this.renderNewsFeed(),e.currentChannel.textContent=MAIN_CHANNEL.slice(0,6)+"..."+MAIN_CHANNEL.slice(-4),await this.fetchPosts(33,true)},e.selfChannel.onclick=async()=>{if(!this.signer)return document.getElementById("statusMessage").textContent="Connect wallet first",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3);const a=(await this.signer.getAddress()).toLowerCase();this.state.newsItems.length=0,this.state.nextPageParams=null,await this.cache.dbOp("newsItems",[],"put"),this.state.channel=a,this.renderNewsFeed(),e.currentChannel.textContent=a.slice(0,6)+"..."+a.slice(-4),await this.fetchPosts(33,true)},e.setCustomChannel.onclick=async()=>{const a=e.customChannelInput.value.trim().toLowerCase();if(!ethers.utils.isAddress(a))return document.getElementById("statusMessage").textContent="Invalid address",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3);this.state.newsItems.length=0,this.state.nextPageParams=null,await this.cache.dbOp("newsItems",[],"put"),this.state.channel=a,this.renderNewsFeed(),e.currentChannel.textContent=a.slice(0,6)+"..."+a.slice(-4),await this.fetchPosts(33,true)},e.profileLink.onclick=async()=>{if(!this.signer)return document.getElementById("statusMessage").textContent="Connect wallet first",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3);e.profileModal.style.display="flex";const p=this.state.profile;e.usernameInput.value=p.username,e.profilePicInput.value=p.profilePicUrl!=="image1.jpeg"?p.profilePicUrl:"",e.profilePicPreview.src=p.profilePicUrl},e.saveProfile.onclick=async()=>{const n=e.usernameInput.value.trim(),i=e.profilePicInput.value.trim()||"image1.jpeg";if(i!=="image1.jpeg"){const m=new Image();m.src=i;if(!await new Promise(r=>{m.onload=()=>{r(true)},m.onerror=()=>{r(false)}}))return document.getElementById("statusMessage").textContent="Invalid URL",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}this.state.profile={username:n,profilePicUrl:i},await this.cache.dbOp("profiles",{address:this.state.signerAddress,username:n,profilePicUrl:i},"put"),e.submissionAvatar.src=i,e.profileModal.style.display="none",this.renderNewsFeed(),document.getElementById("statusMessage").textContent="Profile saved",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)},e.clearProfile.onclick=async()=>{await this.cache.dbOp("profiles",this.state.signerAddress,"delete"),this.state.profile={username:"",profilePicUrl:"image1.jpeg"},e.submissionAvatar.src="image1.jpeg",e.profileModal.style.display="none",this.renderNewsFeed(),document.getElementById("statusMessage").textContent="Profile cleared",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)},e.closeProfileModal.onclick=()=>{e.profileModal.style.display="none"},e.profilePicInput.oninput=()=>{const u=e.profilePicInput.value.trim()||"image1.jpeg",i=new Image();i.src=u,i.onload=()=>{e.profilePicPreview.src=u},i.onerror=()=>{e.profilePicPreview.src="image1.jpeg"}}}async toggleWallet(){const{walletInfo,connectWallet,walletAddress,submissionAvatar}=this.elements;if(this.signer){this.signer=null,this.state.signerAddress=null,walletInfo.style.display="none",connectWallet.textContent="Connect Wallet",walletAddress.textContent="",submissionAvatar.src="image1.jpeg",this.state.profile={username:"",profilePicUrl:"image1.jpeg"},this.renderNewsFeed(),document.getElementById("statusMessage").textContent="Wallet disconnected",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}else{if(!window.ethereum)return document.getElementById("statusMessage").textContent="MetaMask not detected",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3);try{const p=new ethers.providers.Web3Provider(window.ethereum);if((await p.getNetwork()).chainId!==PULSE_CHAIN_ID)await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x171"}]});await p.send("eth_requestAccounts",[]),this.signer=p.getSigner(),this.state.signerAddress=(await this.signer.getAddress()).toLowerCase(),this.state.profile=await this.cache.dbOp("profiles",this.state.signerAddress,"get",true)||{username:"",profilePicUrl:"image1.jpeg"},walletAddress.textContent=this.state.signerAddress.slice(0,6)+"..."+this.state.signerAddress.slice(-4),walletInfo.style.display="block",connectWallet.textContent="Disconnect Wallet",submissionAvatar.src=this.state.profile.profilePicUrl,document.getElementById("statusMessage").textContent="Wallet connected",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}catch(e){document.getElementById("statusMessage").textContent="Connection failed: "+e.message,document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}}}async publishStory(){const{reportContent,loadMoreButton}=this.elements;if(!this.signer)return document.getElementById("statusMessage").textContent="Connect wallet first",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3);const c=reportContent.value.trim();if(!c)return document.getElementById("statusMessage").textContent="Content cannot be empty",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3);loadMoreButton.disabled=true,document.getElementById("loadingOverlay").style.display="flex";try{const n={content:c,reporter:this.state.signerAddress,timestamp:new Date().toISOString(),txHash:(await this.signer.sendTransaction({to:this.state.channel,value:0,data:ethers.utils.hexlify(ethers.utils.toUtf8Bytes(c)),gasLimit:150000})).hash};this.state.newsItems.unshift(n),await this.cache.dbOp("newsItems",[n],"put"),reportContent.value="",this.renderNewsFeed(),document.getElementById("statusMessage").textContent=`Published: ${n.txHash.slice(0,6)}...${n.txHash.slice(-4)}`,document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}catch(e){document.getElementById("statusMessage").textContent="Publish failed: "+e.message,document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}finally{loadMoreButton.disabled=false,document.getElementById("loadingOverlay").style.display="none"}}async fetchPosts(t,i){const n=this.state.newsItems,{loadMoreButton,newsFeed}=this.elements;if(this.state.isLoading||!loadMoreButton||!newsFeed)return console.error("loadMoreButton or newsFeed undefined");loadMoreButton.disabled=true,document.getElementById("loadingOverlay").style.display="flex",this.state.isLoading=true;try{console.log("Fetch posts, target:",t,"current:",n.length,"initial:",i),i&&(n.length=0);let c=t-n.length;if(c<=0&&!i)return;let p=0;while(c>0&&this.state.nextPageParams!==null){console.log("Retry fetch, needed:",c);const u=`https://api.scan.pulsechain.com/api/v2/addresses/${this.state.channel}/transactions?limit=33${this.state.nextPageParams?`&${new URLSearchParams(this.state.nextPageParams)}`:""}`;console.log("Fetching:",u);let r=await fetch(u);if(!r.ok){const t=await r.text().catch(()=>"");throw new Error(`API error: ${r.status} ${t}`)}const d=await r.json();console.log("Fetch response:",r.status,d.items?.length||0,"items");const q=this.parseTransactions(d.items||[]);this.state.nextPageParams=d.next_page_params;console.log("Fetched:",q.length,"nextPageParams:",this.state.nextPageParams);const h=new Map(n.map(j=>[j.txHash,true]));console.log("Unique txHashes:",h.size);const w=q.filter(o=>!h.has(o.txHash)).slice(0,c);console.log("Fetched:",q.length,"Added:",w.length),n.push(...w.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))),await this.cache.dbOp("newsItems",w,"put"),c-=w.length,p+=w.length}if(p||this.state.nextPageParams)this.renderNewsFeed();if(!p&&i){document.getElementById("statusMessage").textContent="No posts found",document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}}catch(e){console.error("Fetch error:",e.message),document.getElementById("statusMessage").textContent="Fetch failed: "+e.message,document.getElementById("statusMessage").style.display="block",setTimeout(()=>{document.getElementById("statusMessage").style.display="none"},3e3)}finally{this.state.isLoading=false,loadMoreButton.disabled=false,document.getElementById("loadingOverlay").style.display="none",i||n.length&&window.scrollTo({top:0,behavior:"smooth"})}}parseTransactions(t){let s=0;console.log("Parsing:",t.length,"transactions");const p=[];for(const i of t){if(!i.raw_input||i.raw_input==="0x"){s++;continue}try{const c=ethers.utils.toUtf8String(i.raw_input)||i.raw_input;console.log("Transaction:",i.hash,"input:",c);if(c===i.raw_input&&c.startsWith("0x")){s++;continue}p.push({content:c,reporter:i.from?.hash||i.from,timestamp:i.timestamp||new Date().toISOString(),txHash:i.hash})}catch(e){console.error("Parse error for",i.hash,":",e.message),s++}}return console.log("Skipped:",s,"invalid transactions"),console.log("Valid:",p.length,"posts"),p}renderNewsFeed(){const{newsItems: n,searchTerm: t,signerAddress: a,profile: p}=this.state,{newsFeed: f,loadMoreButton: b}=this.elements;if(!f||!b)return console.error("newsFeed or loadMoreButton undefined");f.innerHTML="",console.log("Rendering, searchTerm:",t,"items:",n.length);const d=document.createDocumentFragment(),q=t.trim().toLowerCase(),w=n.filter(i=>!q||i.content.toLowerCase().includes(q)||i.reporter.toLowerCase().includes(q));w.forEach(i=>{const e=document.createElement("div");e.className="news-item";const r=i.reporter.toLowerCase()===a;e.innerHTML=`<div class="reporter-info"><img src="${r&&p.profilePicUrl?p.profilePicUrl:"image1.jpeg"}" class="avatar"><div class="reporter-details"><span class="reporter-name">${r&&p.username?p.username:i.reporter.slice(0,6)+"..."+i.reporter.slice(-4)}</span> · ${new Date(i.timestamp).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"})}</div></div><div class="report-content">${i.content.replace(/\n/g,"<br>")}</div>`,d.appendChild(e)}),console.log("Filtered:",w.length,"posts"),f.appendChild(d),f.innerHTML=w.length?f.innerHTML:"No posts available.",b.style.display=w.length&&this.state.nextPageParams?"block":"none",b.textContent=w.length?"Load More":"Top",b.disabled=this.state.isLoading,console.log("Button state, items:",n.length,"filtered:",w.length,"isLoading:",this.state.isLoading)}}new PulseUnderground().init();</script></body></html>
