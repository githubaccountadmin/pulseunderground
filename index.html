<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulse Underground</title>
    <link rel="icon" type="image/jpeg" href="image1.jpeg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #7c4dff;
            --primary-light: #b388ff;
            --bg-dark: #0d0b14;
            --bg-light: #13101c;
            --bg-lighter: #1a1327;
            --border: #2a2438;
            --text: #fff;
            --neon-glow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 15px var(--primary);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.5;
            font-size: 16px;
        }
        #app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            background: var(--bg-dark);
        }
        #sidebar-left {
            width: 250px;
            position: sticky;
            top: 0;
            height: 100vh;
            background: var(--bg-light);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }
        #sidebar-right {
            width: 300px;
            position: sticky;
            top: 0;
            height: 100vh;
            background: var(--bg-light);
            border-left: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }
        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 100px;
            height: auto;
        }
        h1 { font-size: 24px; color: var(--primary-light); text-align: center; margin-bottom: 20px; }
        h3 { font-size: 18px; color: var(--primary-light); margin-bottom: 15px; }
        nav ul { list-style: none; }
        nav ul li { margin-bottom: 10px; }
        nav a {
            display: flex;
            align-items: center;
            color: var(--text);
            text-decoration: none;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s, box-shadow 0.2s;
        }
        nav a:hover { background: var(--bg-lighter); box-shadow: var(--neon-glow); }
        .icon { width: 20px; height: 20px; margin-right: 15px; filter: drop-shadow(0 0 2px var(--primary)); }
        main {
            flex-grow: 1;
            width: calc(1280px - 250px - 300px);
            background: var(--bg-light);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            padding: 20px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, var(--primary), var(--primary-light));
            color: var(--text);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
            margin-bottom: 15px;
        }
        button:hover { background: linear-gradient(45deg, #6a3fff, #a370ff); box-shadow: var(--neon-glow); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        #publishStory {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #loadMoreButton {
            width: auto;
            padding: 8px 20px;
            font-size: 14px;
            margin: 20px auto;
            display: none;
        }
        #storySubmission {
            display: flex;
            padding: 15px;
            background: var(--bg-lighter);
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        .avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; }
        .input-container { flex-grow: 1; position: relative; }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            resize: none;
        }
        textarea:focus { outline: none; border-color: var(--primary); box-shadow: var(--neon-glow); }
        .news-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .news-item:hover { background: var(--bg-lighter); }
        .reporter-info { display: flex; align-items: center; margin-bottom: 10px; }
        .reporter-details { font-size: 14px; margin-left: 10px; }
        .reporter-name { font-weight: bold; }
        .report-content { margin: 10px 0; line-height: 1.6; }
        #searchInput {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            margin-bottom: 20px;
        }
        #searchInput:focus { outline: none; border-color: var(--primary); box-shadow: var(--neon-glow); }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 11, 20, 0.8);
            color: var(--text);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #statusMessage {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-light);
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1001;
            box-shadow: var(--neon-glow);
        }
        #channelSelection {
            margin-top: 20px;
        }
        #channelSelection h3 {
            font-size: 18px;
            color: var(--primary-light);
            margin-bottom: 10px;
        }
        #channelSelection button {
            width: 100%;
            margin-bottom: 10px;
        }
        #customChannelInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: var(--bg-lighter);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text);
        }
        #currentChannel {
            font-size: 14px;
            color: var(--text);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="sidebar-left">
            <img src="image1.jpeg" alt="Pulse Underground Logo" class="logo">
            <nav>
                <ul>
                    <li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"></path><path d="M9 22V12h6v10"></path></svg></span>Home</a></li>
                    <li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M21 21l-6-6m2-5a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"></path></svg></span>Explore</a></li>
                    <li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M12 22c5.5 0 10-4.5 10-10S17.5 2 12 2 2 6.5 2 12s4.5 10 10 10zM12 8v4M12 16h.01"></path></svg></span>Notifications</a></li>
                    <li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>Messages</a></li>
                    <li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span>Profile</a></li>
                </ul>
            </nav>
            <button id="connectWallet">Connect Wallet</button>
            <div id="walletInfo" style="display: none;">
                <p>Connected: <span id="walletAddress"></span></p>
            </div>
        </div>
        <main>
            <h1>The Pulse Underground</h1>
            <div id="storySubmission">
                <img src="image1.jpeg" alt="User Avatar" class="avatar">
                <div class="input-container">
                    <textarea id="reportContent" placeholder="What's happening?"></textarea>
                    <button id="publishStory">➤</button>
                </div>
            </div>
            <div id="newsFeed"></div>
            <button id="loadMoreButton">Load More</button>
        </main>
        <div id="sidebar-right">
            <input type="text" id="searchInput" placeholder="Search The Pulse Underground">
            <div id="channelSelection">
                <h3>Channels</h3>
                <button id="mainChannel">Main Channel</button>
                <button id="selfChannel">Self Channel</button>
                <input type="text" id="customChannelInput" placeholder="Enter custom address">
                <button id="setCustomChannel">Set Custom Channel</button>
                <p>Current Channel: <span id="currentChannel"></span></p>
            </div>
            <div id="activeChannels">
                <h3>Active Channels</h3>
                <p>Coming soon...</p>
            </div>
        </div>
    </div>
    <div id="loadingOverlay">Loading...</div>
    <div id="statusMessage"></div>

    <script>
        const ethers = window.ethers;
        const MAIN_CHANNEL_ADDRESS = "0x9Cd83BE15a79646A3D22B81fc8dDf7B7240a62cB".toLowerCase();
        const PULSE_CHAIN_ID = 369;

        // Utility Functions
        function shortenAddress(addr) {
            return addr?.length > 10 ? addr.slice(0, 6) + "..." + addr.slice(-4) : addr || "Unknown";
        }
        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString("en-US", {
                month: "short", day: "numeric", year: "numeric", hour: "2-digit", minute: "2-digit"
            });
        }
        function showStatus(message, duration = 3000) {
            const status = document.getElementById("statusMessage");
            status.textContent = message;
            status.style.display = "block";
            setTimeout(() => status.style.display = "none", duration);
        }
        function toggleLoading(show) {
            document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
        }

        // IndexedDB Cache Class
        class Cache {
            constructor() {
                this.db = null;
                this.initDB();
            }
            initDB() {
                const request = indexedDB.open("PulseUndergroundCache", 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains("newsItems")) {
                        db.createObjectStore("newsItems", { keyPath: "txHash" });
                    }
                };
                request.onsuccess = () => this.db = request.result;
                request.onerror = () => showStatus("IndexedDB Error");
            }
            async getAllItems() {
                if (!this.db) await new Promise(resolve => setTimeout(resolve, 100));
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction("newsItems", "readonly");
                    const store = tx.objectStore("newsItems");
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            async saveItems(items) {
                if (!this.db) await new Promise(resolve => setTimeout(resolve, 100));
                const tx = this.db.transaction("newsItems", "readwrite");
                const store = tx.objectStore("newsItems");
                items.forEach(item => store.put(item));
                return new Promise((resolve, reject) => {
                    tx.oncomplete = resolve;
                    tx.onerror = () => reject(tx.error);
                });
            }
        }

        // Main Application Class
        class PulseUnderground {
            constructor() {
                this.state = {
                    newsItems: [],
                    searchTerm: "",
                    isLoading: false,
                    hasMore: true,
                    nextPageParams: null,
                    currentChannel: MAIN_CHANNEL_ADDRESS || ""
                };
                this.elements = {
                    newsFeed: document.getElementById("newsFeed"),
                    reportContent: document.getElementById("reportContent"),
                    searchInput: document.getElementById("searchInput"),
                    loadMoreButton: document.getElementById("loadMoreButton"),
                    connectWallet: document.getElementById("connectWallet"),
                    walletInfo: document.getElementById("walletInfo"),
                    walletAddress: document.getElementById("walletAddress"),
                    publishStory: document.getElementById("publishStory"),
                    mainChannel: document.getElementById("mainChannel"),
                    selfChannel: document.getElementById("selfChannel"),
                    customChannelInput: document.getElementById("customChannelInput"),
                    setCustomChannel: document.getElementById("setCustomChannel"),
                    currentChannel: document.getElementById("currentChannel")
                };
                this.cache = new Cache();
                this.signer = null;
                this.initialize();
            }
            async initialize() {
                await this.cache.saveItems([]);
                await this.loadCachedData();
                this.setupEventListeners();
                this.updateCurrentChannelDisplay();
                await this.fetchMultipleNews(33);
            }
            setupEventListeners() {
                this.elements.connectWallet.addEventListener("click", () => {
                    this.signer ? this.disconnectWallet() : this.connectWallet();
                });
                this.elements.publishStory.addEventListener("click", () => this.publishStory());
                this.elements.searchInput.addEventListener("input", this.debounce(() => {
                    this.state.searchTerm = this.elements.searchInput.value.trim().toLowerCase();
                    this.renderNewsFeed();
                }, 300));
                this.elements.mainChannel.addEventListener("click", () => this.setChannel(MAIN_CHANNEL_ADDRESS));
                this.elements.selfChannel.addEventListener("click", async () => {
                    if (!this.signer) {
                        showStatus("Please connect your wallet first");
                        return;
                    }
                    const address = await this.signer.getAddress();
                    this.setChannel(address.toLowerCase());
                });
                this.elements.setCustomChannel.addEventListener("click", () => {
                    const customAddress = this.elements.customChannelInput.value.trim().toLowerCase();
                    if (ethers.utils.isAddress(customAddress)) {
                        this.setChannel(customAddress);
                    } else {
                        showStatus("Invalid Ethereum address");
                    }
                });
                this.elements.loadMoreButton.addEventListener("click", () => this.handleLoadMoreClick());
            }
            debounce(fn, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => fn.apply(this, args), delay);
                };
            }
            async loadCachedData() {
                try {
                    const cachedItems = await this.cache.getAllItems();
                    this.state.newsItems = cachedItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    this.renderNewsFeed();
                } catch (error) {
                    showStatus("Error loading cached data");
                }
            }
            async connectWallet() {
                try {
                    if (!window.ethereum) throw new Error("MetaMask not detected");
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const network = await provider.getNetwork();
                    if (network.chainId !== PULSE_CHAIN_ID) {
                        await window.ethereum.request({
                            method: "wallet_switchEthereumChain",
                            params: [{ chainId: "0x171" }]
                        });
                    }
                    await provider.send("eth_requestAccounts", []);
                    this.signer = provider.getSigner();
                    const address = await this.signer.getAddress();
                    this.elements.walletAddress.textContent = shortenAddress(address);
                    this.elements.walletInfo.style.display = "block";
                    this.elements.connectWallet.textContent = "Disconnect Wallet";
                    showStatus("Wallet connected successfully");
                } catch (error) {
                    showStatus("Wallet connection failed: " + (error.message || "Unknown error"));
                }
            }
            disconnectWallet() {
                this.signer = null;
                this.elements.walletInfo.style.display = "none";
                this.elements.connectWallet.textContent = "Connect Wallet";
                showStatus("Wallet disconnected");
            }
            async publishStory() {
                if (!this.signer) {
                    showStatus("Please connect your wallet first");
                    return;
                }
                const content = this.elements.reportContent.value.trim();
                if (!content) {
                    showStatus("Story content cannot be empty");
                    return;
                }
                try {
                    toggleLoading(true);
                    const inputData = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(content));
                    const tx = {
                        to: this.state.currentChannel,
                        value: 0,
                        data: inputData,
                        gasLimit: 150000
                    };
                    const signedTx = await this.signer.sendTransaction(tx);
                    const receipt = await signedTx.wait();
                    const newItem = {
                        content,
                        reporter: await this.signer.getAddress(),
                        timestamp: new Date().toISOString(),
                        txHash: receipt.transactionHash
                    };
                    this.state.newsItems.unshift(newItem);
                    await this.cache.saveItems([newItem]);
                    this.renderNewsFeed();
                    this.elements.reportContent.value = "";
                    showStatus("Story published: " + shortenAddress(receipt.transactionHash));
                } catch (error) {
                    showStatus("Publishing failed: " + (error.message || "Unknown error"));
                } finally {
                    toggleLoading(false);
                }
            }
            async fetchOnePage() {
                if (!this.state.hasMore || !this.state.currentChannel) return [];
                const url = `https://api.scan.pulsechain.com/api/v2/addresses/${this.state.currentChannel}/transactions?limit=33${this.state.nextPageParams ? "&" + new URLSearchParams(this.state.nextPageParams).toString() : ""}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const data = await response.json();
                    const newItems = this.parseTransactions(data.items || []);
                    this.state.nextPageParams = data.next_page_params;
                    this.state.hasMore = !!data.next_page_params;
                    return newItems;
                } catch (error) {
                    this.state.hasMore = false;
                    showStatus("Fetch failed: " + (error.message || "Unknown error"));
                    return [];
                }
            }
            async fetchMultipleNews(targetPosts) {
                if (this.state.isLoading || !this.state.currentChannel) {
                    showStatus("No channel selected");
                    return;
                }
                this.state.isLoading = true;
                toggleLoading(true);
                try {
                    while (this.state.newsItems.length < targetPosts && this.state.hasMore) {
                        const newPosts = await this.fetchOnePage();
                        const uniqueNewPosts = newPosts.filter(post => 
                            !this.state.newsItems.some(item => item.txHash === post.txHash)
                        );
                        if (uniqueNewPosts.length === 0 && !this.state.nextPageParams) {
                            this.state.hasMore = false;
                            break;
                        }
                        this.state.newsItems = [...this.state.newsItems, ...uniqueNewPosts]
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        await this.cache.saveItems(uniqueNewPosts);
                    }
                    this.state.newsItems = this.state.newsItems
                        .filter((item, index, self) => 
                            index === self.findIndex(i => i.txHash === item.txHash)
                        );
                    this.renderNewsFeed();
                    this.updateLoadMoreButton();
                    if (this.state.newsItems.length < targetPosts && !this.state.hasMore) {
                        showStatus("No more transactions found");
                    }
                } catch (error) {
                    showStatus("Failed to load news: " + (error.message || "Unknown error"));
                } finally {
                    this.state.isLoading = false;
                    toggleLoading(false);
                }
            }
            parseTransactions(transactions) {
                const items = [];
                for (const tx of transactions) {
                    if (tx.raw_input && tx.raw_input !== "0x") {
                        try {
                            const content = ethers.utils.toUtf8String(tx.raw_input).trim();
                            if (content.length > 0) {
                                items.push({
                                    content,
                                    reporter: tx.from?.hash || tx.from,
                                    timestamp: tx.timestamp || new Date().toISOString(),
                                    txHash: tx.hash
                                });
                            }
                        } catch (e) {
                            // Skip invalid UTF-8 data
                        }
                    }
                }
                return items;
            }
            async loadMore() {
                const targetPosts = this.state.newsItems.length + 33;
                await this.fetchMultipleNews(targetPosts);
            }
            async setChannel(address) {
                this.state.currentChannel = address.toLowerCase();
                this.state.newsItems = [];
                this.state.nextPageParams = null;
                this.state.hasMore = true;
                await this.cache.saveItems([]);
                this.renderNewsFeed();
                this.updateCurrentChannelDisplay();
                await this.fetchMultipleNews(33);
            }
            updateCurrentChannelDisplay() {
                if (this.elements.currentChannel) {
                    this.elements.currentChannel.textContent = this.state.currentChannel ? shortenAddress(this.state.currentChannel) : "No channel selected";
                }
            }
            renderNewsFeed() {
                const filteredItems = this.state.searchTerm
                    ? this.state.newsItems.filter(item =>
                        item.content.toLowerCase().includes(this.state.searchTerm) ||
                        item.reporter.toLowerCase().includes(this.state.searchTerm))
                    : [...this.state.newsItems];
                this.elements.newsFeed.innerHTML = "";
                if (!filteredItems.length) {
                    this.elements.newsFeed.textContent = "No news items available.";
                } else {
                    const fragment = document.createDocumentFragment();
                    filteredItems.forEach(item => {
                        const div = document.createElement("div");
                        div.className = "news-item";
                        div.innerHTML = `
                            <div class="reporter-info">
                                <img src="image1.jpeg" alt="Reporter" class="avatar">
                                <div class="reporter-details">
                                    <span class="reporter-name">${shortenAddress(item.reporter)}</span> · ${formatDate(item.timestamp)}
                                </div>
                            </div>
                            <div class="report-content">${item.content.replace(/\n/g, "<br>")}</div>
                        `;
                        fragment.appendChild(div);
                    });
                    this.elements.newsFeed.appendChild(fragment);
                }
                this.updateLoadMoreButton();
            }
            updateLoadMoreButton() {
                if (this.state.newsItems.length > 0) {
                    this.elements.loadMoreButton.style.display = "block";
                    this.elements.loadMoreButton.textContent = this.state.hasMore ? "Load More" : "Return to Top";
                    this.elements.loadMoreButton.disabled = false;
                } else {
                    this.elements.loadMoreButton.style.display = "none";
                }
            }
            handleLoadMoreClick() {
                if (this.state.hasMore) {
                    this.loadMore();
                } else {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                }
            }
        }

        // Start the application
        const app = new PulseUnderground();

        // Home button scrolls to top
        document.querySelector("#sidebar-left nav ul li:first-child a").addEventListener("click", (e) => {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: "smooth" });
        });
    </script>
</body>
</html>
