<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Pulse Underground</title><link rel="icon" type="image/jpeg" href="image1.jpeg"><script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script><style>:root{--primary:#7c4dff;--primary-light:#b388ff;--bg-dark:#0d0b14;--bg-light:#13101c;--bg-lighter:#1a1327;--border:#2a2438;--text:#fff;--neon-glow:0 0 5px var(--primary),0 0 10px var(--primary),0 0 15px var(--primary);}*{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg-dark);color:var(--text);line-height:1.5;font-size:16px}#app-container{display:flex;min-height:100vh;max-width:1280px;margin:0 auto}#sidebar-left,#sidebar-right{position:sticky;top:0;height:100vh;background:var(--bg-light);padding:20px;overflow-y:auto}#sidebar-left{width:250px;border-right:1px solid var(--border)}#sidebar-right{width:300px;border-left:1px solid var(--border)}.logo{display:block;margin:0 auto 20px;width:100px}h1{font-size:24px;color:var(--primary-light);text-align:center;margin-bottom:20px}h3{font-size:18px;color:var(--primary-light);margin-bottom:15px}nav ul{list-style:none}nav ul li{margin-bottom:10px}nav a{display:flex;align-items:center;color:var(--text);text-decoration:none;padding:10px;border-radius:8px;transition:background .2s,box-shadow .2s}nav a:hover{background:var(--bg-lighter);box-shadow:var(--neon-glow)}.icon{width:20px;height:20px;margin-right:15px;filter:drop-shadow(0 0 2px var(--primary))}main{flex-grow:1;width:calc(1280px - 550px);background:var(--bg-light);border:1px solid var(--border);padding:20px}button{width:100%;padding:12px;background:linear-gradient(45deg,var(--primary),var(--primary-light));color:var(--text);border:none;border-radius:8px;font-weight:bold;cursor:pointer;transition:background .3s,box-shadow .3s;margin-bottom:15px}button:hover{background:linear-gradient(45deg,#6a3fff,#a370ff);box-shadow:var(--neon-glow)}button:disabled{opacity:.6;cursor:not-allowed}#publishStory{position:absolute;bottom:10px;right:10px;width:40px;height:40px;border-radius:50%;padding:0;display:flex;align-items:center;justify-content:center}#refreshButton{width:auto;padding:8px 20px;font-size:14px;margin:20px auto;display:block}#newStoriesButton{display:none;position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:999;padding:10px;background:var(--primary);border:none;color:var(--text);border-radius:20px;cursor:pointer}#storySubmission{display:flex;padding:15px;background:var(--bg-lighter);border-bottom:1px solid var(--border);margin-bottom:20px}.avatar{width:48px;height:48px;border-radius:50%;margin-right:15px}.input-container{flex-grow:1;position:relative}textarea{width:100%;min-height:100px;padding:15px;background:var(--bg-light);border:1px solid var(--border);border-radius:8px;color:var(--text);resize:none}textarea:focus{outline:none;border-color:var(--primary);box-shadow:var(--neon-glow)}.news-item{padding:15px;border-bottom:1px solid var(--border);transition:background .2s}.news-item:hover{background:var(--bg-lighter)}.reporter-info{display:flex;align-items:center;margin-bottom:10px}.reporter-details{font-size:14px;margin-left:10px}.reporter-name{font-weight:bold}.report-content{margin:10px 0;line-height:1.6}#searchInput,#customChannelInput{width:100%;padding:12px 15px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:20px;color:var(--text);margin-bottom:20px}#searchInput:focus,#customChannelInput:focus{outline:none;border-color:var(--primary);box-shadow:var(--neon-glow)}#loadingOverlay,#profileModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,11,20,.8);color:var(--text);display:none;justify-content:center;align-items:center;z-index:1000}#statusMessage{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg-light);padding:10px 20px;border-radius:5px;display:none;z-index:1001;box-shadow:var(--neon-glow)}#channelSelection{margin-top:20px}#currentChannel{font-size:14px;color:var(--text);margin-top:10px}.modal-content{background:var(--bg-light);padding:20px;border-radius:8px;width:400px;max-width:90%;border:1px solid var(--border)}.modal-content h2{color:var(--primary-light);margin-bottom:20px}.modal-content label{display:block;margin-bottom:10px;font-size:14px}.modal-content input{width:100%;padding:10px;margin-bottom:15px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:5px;color:var(--text)}.modal-content img{width:100px;height:100px;border-radius:50%;margin-bottom:15px;display:block;margin-left:auto;margin-right:auto}.modal-buttons{display:flex;gap:10px}</style></head><body><div id="app-container"><div id="sidebar-left"><img src="image1.jpeg" alt="Pulse Underground Logo" class="logo"><nav><ul><li><a href="#" id="homeLink"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"></path><path d="M9 22V12h6v10"></path></svg></span>Home</a></li><li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M21 21l-6-6m2-5a7 7 0 1 0-14 0 7 7 0 0 0 14 0z"></path></svg></span>Explore</a></li><li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M12 22c5.5 0 10-4.5 10-10S17.5 2 12 2 2 6.5 2 12s4.5 10 10 10zM12 8v4M12 16h.01"></path></svg></span>Notifications</a></li><li><a href="#"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></span>Messages</a></li><li><a href="#" id="profileLink"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span>Profile</a></li></ul></nav><button id="connectWallet">Connect Wallet</button><div id="walletInfo" style="display:none"><p>Connected: <span id="walletAddress"></span></p></div></div><main><button id="newStoriesButton">New stories available</button><h1>The Pulse Underground</h1><div id="storySubmission"><img src="image1.jpeg" alt="User Avatar" class="avatar" id="submissionAvatar"><div class="input-container"><textarea id="reportContent" placeholder="What's happening?"></textarea><button id="publishStory">âž¤</button></div></div><div id="newsFeed"></div><button id="refreshButton">Refresh</button></main><div id="sidebar-right"><input type="text" id="searchInput" placeholder="Search The Pulse Underground"><div id="channelSelection"><h3>Channels</h3><button id="mainChannel">Main Channel</button><button id="selfChannel">Self Channel</button><input type="text" id="customChannelInput" placeholder="Enter custom address"><button id="setCustomChannel">Set Custom Channel</button><p>Current Channel: <span id="currentChannel"></span></p></div><div id="activeChannels"><h3>Active Channels</h3><p>Coming soon...</p></div></div></div><div id="loadingOverlay">Loading...</div><div id="statusMessage"></div><div id="profileModal"><div class="modal-content"><h2>Edit Profile</h2><img src="image1.jpeg" alt="Profile Preview" id="profilePicPreview"><label for="usernameInput">Username:</label><input type="text" id="usernameInput" placeholder="Enter username"><label for="profilePicInput">Profile Picture URL:</label><input type="text" id="profilePicInput" placeholder="Enter image URL"><div class="modal-buttons"><button id="saveProfile">Save</button><button id="clearProfile">Clear Profile</button><button id="closeProfileModal">Close</button></div></div></div><script>const ethers=window.ethers,MAIN_CHANNEL="0x9cd83be15a79646a3d22b81fc8ddf7b7240a62cb",PULSE_CHAIN_ID=369;const utils={showStatus:(m,d=3e3)=>{const s=document.getElementById("statusMessage");s.textContent=m;s.style.display="block";setTimeout(()=>{s.style.display="none"},d)},toggleLoading:s=>document.getElementById("loadingOverlay").style.display=s?"flex":"none"};class Cache{constructor(){this.db=null;this.initDB()}initDB(){const r=indexedDB.open("PulseUndergroundCache",2);r.onupgradeneeded=e=>{const d=e.target.result;d.objectStoreNames.contains("newsItems")||d.createObjectStore("newsItems",{keyPath:"txHash"});d.objectStoreNames.contains("profiles")||d.createObjectStore("profiles",{keyPath:"address"})};r.onsuccess=()=>{this.db=r.result};r.onerror=()=>utils.showStatus("IndexedDB Error")}async waitForDB(){this.db||await new Promise(r=>setTimeout(r,100))}async getItems(){await this.waitForDB();return new Promise((r,e)=>{const t=this.db.transaction("newsItems","readonly").objectStore("newsItems").getAll();t.onsuccess=()=>r(t.result||[]);t.onerror=()=>e(t.error)})}async saveItems(i){await this.waitForDB();const t=this.db.transaction("newsItems","readwrite"),s=t.objectStore("newsItems");i.forEach(x=>s.put(x));return new Promise((r,e)=>{t.oncomplete=r;t.onerror=()=>e(t.error)})}async getProfile(a){await this.waitForDB();return new Promise((r,e)=>{const t=this.db.transaction("profiles","readonly").objectStore("profiles").get(a);t.onsuccess=()=>r(t.result);t.onerror=()=>e(t.error)})}async saveProfile(p){await this.waitForDB();const t=this.db.transaction("profiles","readwrite").objectStore("profiles");t.put(p);return new Promise((r,e)=>{t.oncomplete=r;t.onerror=()=>e(t.error)})}async clearProfile(a){await this.waitForDB();const t=this.db.transaction("profiles","readwrite").objectStore("profiles");t.delete(a);return new Promise((r,e)=>{t.oncomplete=r;t.onerror=()=>e(t.error)})}}class PulseUnderground{constructor(){this.state={newsItems:[],pendingNewItems:[],searchTerm:"",isLoading:false,hasMore:true,nextPageParams:null,channel:MAIN_CHANNEL,profile:{username:"",profilePicUrl:"image1.jpeg"},signerAddress:null};this.elements={newsFeed:document.getElementById("newsFeed"),reportContent:document.getElementById("reportContent"),searchInput:document.getElementById("searchInput"),refreshButton:document.getElementById("refreshButton"),newStoriesButton:document.getElementById("newStoriesButton"),connectWallet:document.getElementById("connectWallet"),walletInfo:document.getElementById("walletInfo"),walletAddress:document.getElementById("walletAddress"),publishStory:document.getElementById("publishStory"),mainChannel:document.getElementById("mainChannel"),selfChannel:document.getElementById("selfChannel"),customChannelInput:document.getElementById("customChannelInput"),setCustomChannel:document.getElementById("setCustomChannel"),currentChannel:document.getElementById("currentChannel"),submissionAvatar:document.getElementById("submissionAvatar"),profileLink:document.getElementById("profileLink"),profileModal:document.getElementById("profileModal"),usernameInput:document.getElementById("usernameInput"),profilePicInput:document.getElementById("profilePicInput"),profilePicPreview:document.getElementById("profilePicPreview"),saveProfile:document.getElementById("saveProfile"),clearProfile:document.getElementById("clearProfile"),closeProfileModal:document.getElementById("closeProfileModal"),homeLink:document.getElementById("homeLink")};this.cache=new Cache;this.signer=null;this.pollInterval=null;this.init()};async init(){await this.loadCachedData();this.setupListeners();this.elements.currentChannel.textContent=this.truncAddr(this.state.channel);await this.fetchPosts();this.startPolling()};truncAddr=(a)=>{return a.length>10?`${a.slice(0,6)}...${a.slice(-4)}`:a};debounce=(f,d)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f.apply(this,a),d)}};setupListeners=()=>{const e=this.elements;e.connectWallet.onclick=()=>this.toggleWallet();e.publishStory.onclick=()=>this.publishStory();e.searchInput.oninput=this.debounce(()=>{this.state.searchTerm=e.searchInput.value.trim().toLowerCase();this.renderNewsFeed()},300);e.refreshButton.onclick=()=>this.refreshPosts();e.newStoriesButton.onclick=()=>this.loadNewStories();window.addEventListener("scroll",this.debounce(()=>this.checkInfiniteScroll(),200));e.homeLink.onclick=e=>{e.preventDefault();window.scrollTo({top:0,behavior:"smooth"})};e.mainChannel.onclick=()=>this.setChannel(MAIN_CHANNEL);e.selfChannel.onclick=async()=>{if(!this.signer)return utils.showStatus("Connect wallet first");this.setChannel((await this.signer.getAddress()).toLowerCase())};e.setCustomChannel.onclick=()=>{const a=e.customChannelInput.value.trim().toLowerCase();ethers.utils.isAddress(a)?this.setChannel(a):utils.showStatus("Invalid address")};e.profileLink.onclick=e=>{e.preventDefault();if(!this.signer)return utils.showStatus("Connect wallet first");this.showProfileModal()};e.saveProfile.onclick=()=>this.saveProfile();e.clearProfile.onclick=()=>this.clearProfile();e.closeProfileModal.onclick=()=>e.profileModal.style.display="none";e.profilePicInput.oninput=()=>this.previewProfilePic()};async loadCachedData(){const i=await this.cache.getItems();this.state.newsItems=i.filter(x=>x.channel===this.state.channel).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));this.renderNewsFeed()};async toggleWallet(){this.signer?await this.disconnectWallet():await this.connectWallet()};async connectWallet(){if(!window.ethereum)return utils.showStatus("MetaMask not detected");try{const p=new ethers.providers.Web3Provider(window.ethereum);if((await p.getNetwork()).chainId!==PULSE_CHAIN_ID)await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x171"}]});await p.send("eth_requestAccounts",[]);this.signer=p.getSigner();this.state.signerAddress=(await this.signer.getAddress()).toLowerCase();this.elements.walletAddress.textContent=this.truncAddr(this.state.signerAddress);this.elements.walletInfo.style.display="block";this.elements.connectWallet.textContent="Disconnect Wallet";await this.loadProfile();utils.showStatus("Wallet connected")}catch(e){utils.showStatus("Connection failed: "+e.message)}};async disconnectWallet(){this.signer=null;this.state.signerAddress=null;this.state.profile={username:"",profilePicUrl:"image1.jpeg"};this.elements.walletInfo.style.display="none";this.elements.connectWallet.textContent="Connect Wallet";this.renderNewsFeed();utils.showStatus("Wallet disconnected")};async loadProfile(){const p=await this.cache.getProfile(this.state.signerAddress)||{username:"",profilePicUrl:"image1.jpeg"};this.state.profile=p;this.elements.submissionAvatar.src=p.profilePicUrl;this.renderNewsFeed()};async saveProfile(){const n=this.elements.usernameInput.value.trim();let u=this.elements.profilePicInput.value.trim()||"image1.jpeg";if(u!=="image1.jpeg"){const i=new Image;i.src=u;if(!await new Promise(r=>{i.onload=()=>r(true);i.onerror=()=>r(false)}))return utils.showStatus("Invalid profile picture URL")}this.state.profile={username:n,profilePicUrl:u};await this.cache.saveProfile({address:this.state.signerAddress,...this.state.profile});this.elements.submissionAvatar.src=u;this.elements.profileModal.style.display="none";this.renderNewsFeed();utils.showStatus("Profile saved")};async clearProfile(){await this.cache.clearProfile(this.state.signerAddress);this.state.profile={username:"",profilePicUrl:"image1.jpeg"};this.elements.submissionAvatar.src="image1.jpeg";this.elements.profileModal.style.display="none";this.renderNewsFeed();utils.showStatus("Profile cleared")};showProfileModal=()=>{this.elements.usernameInput.value=this.state.profile.username;this.elements.profilePicInput.value=this.state.profile.profilePicUrl!=="image1.jpeg"?this.state.profile.profilePicUrl:"";this.elements.profilePicPreview.src=this.state.profile.profilePicUrl;this.elements.profileModal.style.display="flex"};previewProfilePic=()=>{const u=this.elements.profilePicInput.value.trim()||"image1.jpeg";const i=new Image;i.src=u;i.onload=()=>this.elements.profilePicPreview.src=u;i.onerror=()=>this.elements.profilePicPreview.src="image1.jpeg"};async publishStory(){if(!this.signer)return utils.showStatus("Connect wallet first");const c=this.elements.reportContent.value.trim();if(!c)return utils.showStatus("Content cannot be empty");utils.toggleLoading(true);try{const d=ethers.utils.hexlify(ethers.utils.toUtf8Bytes(c));const t={to:this.state.channel,value:0,data:d};t.gasLimit=await this.signer.estimateGas(t).then(g=>g.mul(120).div(100));const tx=await this.signer.sendTransaction(t);const r=await tx.wait();const n={content:c,reporter:this.state.signerAddress,timestamp:new Date().toISOString(),txHash:r.transactionHash,channel:this.state.channel};this.state.newsItems.unshift(n);await this.cache.saveItems([n]);this.renderNewsFeed();this.elements.reportContent.value="";utils.showStatus("Story published: "+this.truncAddr(r.transactionHash))}catch(e){utils.showStatus("Publish failed: "+e.message)}finally{utils.toggleLoading(false)}};async fetchOnePage(retryCount=0){if(!this.state.hasMore||!this.state.channel)return[];let u=`https://api.scan.pulsechain.com/api/v2/addresses/${this.state.channel}/transactions?limit=50`;if(this.state.nextPageParams)u+="&"+new URLSearchParams(this.state.nextPageParams);try{const r=await fetch(u);if(!r.ok){if(r.status===429&&retryCount<3){await new Promise(res=>setTimeout(res,Math.pow(2,retryCount)*1000));return this.fetchOnePage(retryCount+1)}throw new Error(`API error: ${r.status}`)}const d=await r.json();const i=this.parseTransactions(d.items||[]);this.state.nextPageParams=d.next_page_params;this.state.hasMore=!!d.next_page_params&&i.length>0;return i}catch(e){this.state.hasMore=false;utils.showStatus("Fetch failed: "+e.message);return[]}};async fetchPosts(){if(this.state.isLoading||!this.state.channel)return;this.state.isLoading=true;utils.toggleLoading(true);try{let added=false;while(!added&&this.state.hasMore){const p=await this.fetchOnePage();const u=p.filter(o=>!this.state.newsItems.some(x=>x.txHash===o.txHash));if(u.length){this.state.newsItems=[...this.state.newsItems,...u].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));await this.cache.saveItems(u);added=true}}this.renderNewsFeed()}finally{this.state.isLoading=false;utils.toggleLoading(false)}};parseTransactions=(t)=>{return t.filter(x=>x.raw_input&&x.raw_input!=="0x"&&x.to&&x.to.hash.toLowerCase()===this.state.channel).map(x=>{try{const c=ethers.utils.toUtf8String(x.raw_input).trim();return c.length?{content:c,reporter:x.from?.hash.toLowerCase()||x.from.toLowerCase(),timestamp:x.timestamp||new Date().toISOString(),txHash:x.hash,channel:this.state.channel}:null}catch{return null}}).filter(Boolean)};checkInfiniteScroll=()=>{if(this.state.hasMore&&!this.state.isLoading&&window.innerHeight+window.scrollY>=document.body.offsetHeight)this.fetchPosts()};async refreshPosts(){this.state.nextPageParams=null;this.state.hasMore=true;await this.fetchPosts()};async pollNew(){if(!this.state.channel)return;const currentMax=this.state.newsItems[0]?.timestamp?new Date(this.state.newsItems[0].timestamp):new Date(0);const oldNext=this.state.nextPageParams;this.state.nextPageParams=null;const newItems=[];while(this.state.hasMore){const page=await this.fetchOnePage();const filtered=page.filter(i=>new Date(i.timestamp)>currentMax&&!this.state.newsItems.some(ex=>ex.txHash===i.txHash)&&!newItems.some(ex=>ex.txHash===i.txHash));if(filtered.length)newItems.push(...filtered);if(filtered.length<page.length||!this.state.nextPageParams)break}this.state.nextPageParams=oldNext;if(newItems.length){this.state.pendingNewItems=newItems.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));this.elements.newStoriesButton.style.display="block"}};startPolling=()=>{this.pollInterval=setInterval(()=>this.pollNew(),120000)};stopPolling=()=>{clearInterval(this.pollInterval)};async setChannel(a){this.stopPolling();this.state.channel=a.toLowerCase();this.state.nextPageParams=null;this.state.hasMore=true;this.state.pendingNewItems=[];this.elements.newStoriesButton.style.display="none";const i=await this.cache.getItems();this.state.newsItems=i.filter(x=>x.channel===this.state.channel).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));this.renderNewsFeed();this.elements.currentChannel.textContent=this.truncAddr(a);await this.fetchPosts();this.startPolling()};loadNewStories=()=>{this.state.newsItems=[...this.state.pendingNewItems,...this.state.newsItems];this.state.pendingNewItems=[];this.elements.newStoriesButton.style.display="none";this.renderNewsFeed();window.scrollTo({top:0,behavior:"smooth"})};renderNewsFeed=()=>{const n=this.state.newsItems.filter(x=>this.state.searchTerm?(x.content.toLowerCase().includes(this.state.searchTerm)||x.reporter.toLowerCase().includes(this.state.searchTerm)):true);this.elements.newsFeed.innerHTML="";const f=document.createDocumentFragment();n.forEach(x=>{const d=document.createElement("div");d.className="news-item";const u=x.reporter===this.state.signerAddress;d.innerHTML=`<div class="reporter-info"><img src="${u&&this.state.profile.profilePicUrl?this.state.profile.profilePicUrl:"image1.jpeg"}" alt="Reporter" class="avatar"><div class="reporter-details"><span class="reporter-name">${u&&this.state.profile.username?this.state.profile.username:this.truncAddr(x.reporter)}</span> Â· ${new Date(x.timestamp).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"})}</div></div><div class="report-content">${x.content.replace(/\n/g,"<br>")}</div>`;f.appendChild(d)});this.elements.newsFeed.appendChild(f);this.elements.refreshButton.disabled=this.state.isLoading;this.elements.refreshButton.textContent=this.state.isLoading?"Loading...":"Refresh"}}new PulseUnderground;</script></body></html>
